/**!
 * supportLib.js
 * v2.5.1
 *
 * Copyright(c) 2020 Ed Alegrid
 */
"use strict";const _WebSocket=require("ws"),colors=require("colors"),inquirer=require("inquirer"),m2mv=require("../package.json"),fs=require("fs"),os=require("os"),ip=require("ip"),crypto=require("crypto"),{spawn:spawn,spawnSync:spawnSync,execFileSync:execFileSync}=require("child_process"),{createHash:createHash,createHmac:createHmac}=require("node:crypto"),EventEmitter=require("events");class StateEmitter extends EventEmitter{}const emitter=new StateEmitter;emitter.setMaxListeners(5);const processArgs=process.argv.slice(2);let spl={},options={},socket=null;function showAlert(){console.log("\n***",colors.brightYellow("M2M Module Warning!"),"***"),console.log("The node_modules directory is not inside the project's root directory."),console.log("The m2m module requires that the node_modules directory is inside the project's root directory."),console.log("This will allow the remote endpoint to access all the available features of node-m2m.")}let nmp1="./node_modules/m2m/package.json",nmp2="../node_modules/m2m/package.json",node_module_path=null;try{fs.readFileSync(nmp1),node_module_path=nmp1}catch(e){showAlert(),fs.readFileSync(nmp2),node_module_path=nmp2}exports.setDefaults=function(e,t){e&&(spl=e),t&&(socket=t)},exports.wsCreate=_WebSocket;const m2mUtilLib=exports.m2mUtilLib=function(e){let t="                  Date                                           Event",n=null,r=null,o=null,s=!1,i="m2mConfig/eLog";const a=/^[A-Za-z0-9-_\/]*$/,l=/^[A-Za-z0-9 \[\]"{}':,._-]*$/;function c(e,n){fs.mkdir("m2mConfig/",(r=>{try{if(r)throw r;e?fs.writeFileSync(e,t):fs.writeFileSync(i,t),n&&n()}catch(e){if("EEXIST"!==e.code)throw console.log("initLog error:",r.message),e.message}}))}function d(e,n,r,o,s,i,a,l,d,m){try{s||(s=""),i||(i=""),a||(a=""),l||(l=""),d||(d=""),m||(m=""),function(e,n,r,o,s,i,a,l,d,m){fs.open(e,"r",((n,c)=>{n&&"ENOENT"===n.code&&fs.writeFileSync(e,t);try{fs.appendFileSync(e,"\n"+r+"  "+o+"  "+s+"  "+i+"  "+a+"  "+l+"  "+d+"  "+m)}catch(n){throw n}})),fs.stat(e,((f,u)=>{if(f&&"ENOENT"===f.code&&c(),u&&u.size>n)try{fs.writeFileSync(e,t),fs.appendFileSync(e,"\n"+r+"  "+o+"  "+s+"  "+i+"  "+a+"  "+l+"  "+d+"  "+m)}catch(f){throw f}}))}(e,n,r,o,s,i,a,l,d,m)}catch(e){throw e}}function m(e,t,n,r,o,s,a){let l=new Date,c=l.toDateString()+" "+l.toLocaleTimeString();d(i,35e3,c,e,t,n,r,o,s,a)}s=!("start"!==process.env.npm_lifecycle_event&&!process.env.npm_package_nodemonConfig_restartable),c(),m("process starting pid","("+process.pid+")"),n="linux"===os.platform()?execFileSync("npm",["-v"]):"win32"===os.platform()?execFileSync("npm -v",{shell:!0}):execFileSync("npm",["-v"]);const f={nodev:process.version,npmv:n.toString("utf8"),type:os.arch(),mem:{total:(os.totalmem()/1e6).toFixed(0)+" MB",free:(os.freemem()/1e6).toFixed(0)+" MB"},m2mv:"v"+m2mv.version,os:os.platform(),container:function(){try{return!(process.pid.toString().length>3||(m("process running in container",!0),0))}catch(e){m("isContainer error:",e.message)}}(),ip:ip.address()};function u(){return r=new Date,r}return u(),{st:u,et:function(){return o=new Date,o-r+" ms"},rid:function(e){return crypto.randomBytes(e).toString("hex")},m2mInfo:function(e,t){try{console.log("\n********************************************"),console.log("   m2m ver:",m2mv.version),console.log("   os:",process.platform),console.log("   cpu type:",os.arch()),e.server?(console.log("   endpoint: server"),e.id&&console.log("   id:",e.id,"(user-defined)")):e.client?(console.log("   endpoint: client"),e.clientId&&console.log("   id:",e.clientId,"(auto-generated)")):e.edgeUser&&e.user?(console.log("   endpoint: edge"),e.userId&&console.log("   id:",e.userId,"(auto-generated)")):e.user&&!e.edgeUser&&(console.log("   endpoint: user"),e.userId&&console.log("   id:",e.userId,"(auto-generated)")),console.log("   m2m server:",colors.brightBlue(t),"\n********************************************")}catch(e){m("m2mInfo error:",e.message)}},logData:function(e,t,n,r,o,s,i,a){let l=new Date;d(e,35e3,l.toDateString()+" "+l.toLocaleTimeString(),t,n,r,o,s,i,a)},logEvent:m,setError:function(t,n,r,o){let s=new Error(t);if(m("error:",s.message),!e.emit("node-m2m-error",s))if(n)n({error:s.message});else if(r)r(s);else{if(!o)throw s;o(s)}},systemInfo:f,getUrlKeys:function(e,t){let n=null;const r=[],o=[],s={};t.startsWith("/")||m2mUtil.setError(new Error("path: "+e.name+" - invalid url path, it must begin with a slash /"),null,null);let i=t.indexOf("?",1);-1!==i&&(n=t.substring(i+1,t.length)),new URLSearchParams(n).forEach((function(e,t){s[t]=e}));let a=t.indexOf("?");-1!==a&&(t=t.slice(0,a));for(let e=0;e<t.length;e++)"/"===t[e]&&r.push(e);return r.forEach(((e,n)=>{try{if(0==e&&r[n+1]){let e=t.slice(r[n],r[n+1]);o.push(e)}else if(0!==e&&r[n]&&r[n+1]){let e=t.slice(r[n],r[n+1]);o.push(e)}else{let e=t.slice(r[n],t.length);o.push(e)}}catch(e){m2mUtil.logEvent("urlRoutesIndex.forEach error:",e.message)}})),e.urlPathKeys=o,e.baseUrl=o[0],e.query=s,e},encodeData:function(e,t,n){try{return"object"==typeof e?Buffer.from(JSON.stringify(e)).toString(t):Buffer.from(e).toString(t)}catch(e){n||console.log("encodeData error:",e.message)}},decodeData:function(e,t,n){try{return JSON.parse(Buffer.from(e,t).toString())}catch(e){}try{return Buffer.from(e,t).toString()}catch(e){n||console.log("decodeData string error:",e.message)}},setToBuffer:function(e,t){try{if("base64"===t)return Buffer.from(JSON.stringify(e)).toString("base64");if("hex"===t)return Buffer.from(JSON.stringify(e)).toString("hex")}catch(e){m("setToBuffer error:",e.message)}},getSubTopic:function(e,t){const n=[],r=[];if(!t.startsWith("/"))return e;if(t.includes("?"))throw t+" - invalid topic attribute";for(let e=0;e<t.length;e++)("/"===t[e]||"#"===t[e])&&n.push(e);n.forEach((function(e,o){if(0===e&&n[o+1]){let e=t.slice(n[o],n[o+1]);r.push(e)}else if(0!==e&&n[o]&&n[o+1]){let e=t.slice(n[o],n[o+1]);r.push(e)}else{let e=t.slice(n[o],t.length);r.push(e)}}));let o={};r[0]===t&&1===r.length&&(o.root=r[0]);let s=r[0].length,i=t.slice(s);return e.topicKeys=r,e.baseTopic=r[0],e.subTopic=i,e.rootTopic=o.root,e},getParamKeys:function(e){const t={},n=[],r=[],o={},s=[];for(let t=0;t<e.length;t++)"/"===e[t]&&n.push(t);return n.forEach(((t,o)=>{if(0==t&&n[o+1]){let t=e.slice(n[o],n[o+1]);r.push(t)}else if(0!==t&&n[o]&&n[o+1]){let t=e.slice(n[o],n[o+1]);r.push(t)}else{let t=e.slice(n[o],e.length);r.push(t)}})),r.forEach(((e,t)=>{if(e.startsWith("/:")){let n=e.slice(2,e.length),r={key:n,index:t};o[n]=n,s.push(r)}})),t.urlPathKeys=r,t.baseUrl=r[0],t.params=o,t.paramKeys=s,t.rootPath=r[0],t},startConnect:function(t,n){let r="emit-connect";t&&t.resetServerSetup(),e.listenerCount(r)<1&&e.on(r,(e=>{if(n||console.log(e),n)if(n.length>0){if(Array.isArray(e))return n("registration fail");setImmediate(n,e)}else{if(Array.isArray(e))return console.log("registration fail");console.log("connection:",e),setImmediate(n)}}))},eventLogHeader:t,getRestartStatus:function(){return s},setEpErrorEvent:function(t,n){if("error"!==t)throw new Error(t+" event name is invalid");let r="node-m2m-"+t;e.listenerCount(r)<1&&e.on(r,(e=>{if("object"==typeof e)return n(e);"string"==typeof e&&n(e)}))},validateClientApi:function(e,t,n,r,o,s,i,a){let l={};if("string"==typeof e&&o&&("function"==typeof t&&(i=t,"watch"===s&&(r=5e3)),"function"==typeof n&&(i=n),"function"==typeof r&&(i=r,Number.isInteger(t)&&(r=t)),"write"!==s&&"sendData"!==s&&"post"!==s||(n=t),t=e,e=o),Number.isInteger(e)?(l.id=e,"string"==typeof t&&("get"===s||"post"===s?l.path=t:l.channel=t),"number"!=typeof n&&"string"!=typeof n&&"object"!=typeof n||("post"===s?l.body=n:"write"!==s&&"sendData"!==s||(l.payload=n)),"function"==typeof r&&(i=r,r=5e3),Number.isInteger(r)&&(l.interval=r)):"object"==typeof e&&(i=t,o&&(e.id=o),"watch"===s&&(e.interval||(e.interval=5e3)),"function"==typeof t&&(i=t),l=e),!l.id)throw console.log(l),new Error("validateClientApi error - missing id");if("get"===s||"post"===s){if(!l.path)throw console.log(l),new Error("validateClientApi error - missing path")}else if(l.topic);else if(!l.channel)throw console.log(l),new Error("validateClientApi error - missing channel");if("post"===s){if(!l.body)throw console.log(l),new Error("validateClientApi error - missing body")}else if(("write"===s||"sendData"===s)&&!l.payload)throw console.log(l),new Error("validateClientApi error - missing payload");if("watch"===s&&!l.interval)throw console.log(l),new Error("validateClientApi error - missing interval");return new Promise((function(e,t){"function"==typeof i&&(e=null,t=null),a(l,s,i,e,t)}))},argv:processArgs,validateNameAndPayload:function(e){let t=!0,n=null,r=null;try{if(!e)return void m("validateNameAndPayload !arg:",JSON.stringify(e));if(Array.isArray(e)&&(r=e[0]),r&&(e=r),e.name&&("string"!=typeof e.name&&(t=null),e.name.length>75&&(t=null),e.name.match(a),!t))throw new Error("invalid channel/path");if((e.payload||e.body)&&(e.payload?n=e.payload:e.body&&(n=e.body),"number"==typeof n||"object"==typeof n||"string"==typeof n||(t=null)),n&&(n=JSON.stringify(n),n&&n.length>500&&(t=null),n&&n.match(l),!t))throw e.payload&&(e.payload=null,m("write/sendData - invalid payload data",n)),e.body&&(e.body=null,m("post - invalid body data",n)),new Error("invalid payload/body");return t}catch(e){throw m("validateNameAndPayload error:",e.message),e}},removeDuplicateInArray:function(e){return Array.from(new Set(e))},removeDuplicateObjectInArray:e=>{if(!Array.isArray(e))return m("filterArray invalid array input:",""+e),!1;try{return e.filter(((t,n)=>n===e.findIndex((e=>t.title===e.title))))}catch(e){m("filterArray error:",e.message)}}}},m2mUtil=exports.m2mUtil=m2mUtilLib(emitter),dmLib=exports.dmLib=e=>{let t=[],n=1,r={},o=!0,s=null,i=1,a=!1,l=[],c=[],d=[],m=[],f=[],u=[],g=[],p=[],h=[],y={},v=[];function S(e,t){let n="m2mConfig/ar",r="base64",o="utf8";try{if("r"===e){let e=fs.readFileSync(n,"utf8");e&&(y=JSON.parse(Buffer.from(e,r).toString(o)))}else if("w"===e&&Object.keys(y).length>0&&y.accessRateData&&y.accessRateData[0]){let e=JSON.stringify(y),t=Buffer.from(e,o).toString(r);fs.writeFileSync(n,t)}}catch(e){}}function w(e){i=1,o=!1,l=[],c=[],d=[],m=[],f=[],u=[],g=[],p=[],h=[],y={},y.accessCounter=1,y.monStatus=!1,clearTimeout(s)}function E(e,t){e.forEach(((e,n)=>{let r={id:spl.id,name:e,cpm:0,tcpm:0,arpm:0};t.push(r)}))}function b(e){e.forEach(((e,t)=>{e.tcpm=e.tcpm+e.cpm,e.arpm=(e.tcpm/i).toFixed(n),e.iteration=i;let r=Object.assign({},e);e.tcpm&&h.push(r),e.cpm=0}))}function C(t){o=!0,y.monStatus=!0,t&&(r=t.resources.getServerResources());let n=r.publish.name,a=r.dataSource.name,x=r.get.path,k=r.post.path;1===i&&(E(n,l),E(a,c),E(x,d),E(k,m)),h=[],s=setTimeout((()=>{o=!1,clearTimeout(s),v.forEach(((t,n)=>{try{t.name&&t.watch&&"watch"===t.method?l.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.watch=!0)})):t.name&&t.read&&"read"===t.method?c.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.read=!0)})):t.name&&t.write&&"write"===t.method?c.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.write=!0)})):t.name&&t.get&&"get"===t.method?d.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.get=!0)})):t.name&&t.post&&"post"===t.method&&m.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.post=!0)}))}catch(t){e&&e.logEvent("accessRateMonitoring error:",t.message)}})),b(l),b(c),b(d),b(m),b(f),b(u),b(g),b(p),setImmediate((()=>{y={accessRateData:h,monStatus:!0,accessCounter:i},v=[],setTimeout((()=>{i<60?(S("w"),i++,C(t)):(w(),S("w"),setTimeout((()=>{C(t)}),25))}),1e3)}))}),6e4)}function x(t,n){return t.push("&nbsp"+n),e.removeDuplicateInArray(t)}function k(n){let r=function(e){let t=[],n=systemConfig.getValidServers();return e.getClientRawAccessData().forEach((e=>{n.includes(e.id)&&t.push(e)})),t}(n);return r.forEach((n=>function(n){let r=!1,o=e.systemInfo.ip,s={id:n.id,clientId:n.clientId,ip:o,sub:[],read:[],write:[],get:[],post:[]};n.serverId&&(s.serverId=n.serverId,delete s.clientId),n.srcId&&(s.srcId=n.srcId),n.dstId&&(s.dstId=n.dstId),t.forEach(((e,t)=>{e.id===n.id&&(r=!0)})),!1===r&&t.push(s)}(n))),t.forEach(((t,n)=>{r.forEach(((n,r)=>{try{t.id===n.id&&(n.read&&n.name?t.read=x(t.read,n.name):n.write&&n.name?t.write=x(t.write,n.name):n.watch&&n.name?t.sub=x(t.sub,n.name):n.get&&n.name?t.get=x(t.get,n.name):n.post&&n.name&&(t.post=x(t.post,n.name)))}catch(t){e&&e.logEvent("processRequestResourcesData error:",t.message)}}))})),a=!0,t}return{resources:{collectAccessData:function(e){o&&v.push(e)},getClientAccessData:function(e){return a?t:k(e)},stopMonitorAccessRate:w,startMonitorAccessRate:function(e,t){S("r"),o=!0,setImmediate(C,e)},getserverAccessRateData:function(){return y},resetserverAccessRateData:function(){y={}},processRequestResourcesData:k}}},dm=exports.dm=dmLib(m2mUtil),fimLib=exports.fimLib=t=>{let n=!0,r="m2mConfig/sec/",o="m2mConfig/scfg/sconfig",s=[],i=[],a=[],l=null;function c(e){let n={};try{return n=Buffer.from(JSON.stringify(e)).toString("base64"),fs.writeFileSync(o,n),n}catch(e){return t.logEvent("setSystemConfig error:",e.message),n}}function d(e){let n={};e&&e.path&&(o=e.path);try{n=JSON.parse(Buffer.from(fs.readFileSync(o,"utf8"),"base64").toString())}catch(e){"ENOENT"!==e.code&&t.logEvent("getSystemConfig JSON.parse scpath1 error:",e.message),fs.mkdirSync("m2mConfig/scfg",{recursive:!0})}return n}function m(e,r){try{let o=d();!1===e.enable?(n=!1,o.enable=!1,console.log("endpoint suspended"),r&&r.stopWatchServices(),dm&&dm.resources.stopMonitorAccessRate(t),t.logEvent("endpoint is disabled")):!0===e.enable&&(n=!0,o.enable=!0,console.log("endpoint enabled"),r&&r.startWatchServices(),dm&&r&&dm.resources.startMonitorAccessRate(r,t),t.logEvent("endpoint is enabled")),c(o)}catch(e){t.logEvent("suspend error:",e.message)}}function f(n,r,o,s){try{let i=d();if(i.fim){let a=Object.assign({},spl);a.fim=!0,a._pid="fi-change",a.restartable=t.getRestartStatus(),fs.readFileSync(n),a.filename=t.setToBuffer(n,"base64"),a.item={},"af"===r?a.item.af=!0:"sf"===r?a.item.sf=!0:"wf"===r&&(a.item.wf=!0),o&&(a.item.fn=o),s&&(a.result=s),a.stdFim=!0,(i.ar||i.ar1||i.ar2)&&(i.enable=!1,a.enable=!1),a.sconfig=i,socket.send(a),function(n){n||t.logEvent("startActiveResponse error:",e.message),n.ar&&m({enable:!1}),n.ar1&&process.kill(process.pid,"SIGINT"),n.ar2}(i)}}catch(e){e.code,t.logEvent("FimResponse - getSystemConfig error:",e.message)}}function u(e,n,r){try{if(n.length>0)for(let t=0;t<n.length;t++)if(n[t]&&n[t].filename&&e&&n[t].filename===e)return r?void r(null,!0,t):{result:!0,x:t};return!!r&&void r(null,!1)}catch(e){r&&r(e),t.logEvent("findFileName error:",e.message)}}function g(e,n,r){u(e,n,((e,o,s)=>{if(e)throw e;if(o)try{n[s].fileWatcher.close(),n.splice(s,1),r&&r(!0)}catch(e){t.logEvent("closeExtWatchFile - findFileName error:",e.message)}}))}let p=[],h=["node_modules/m2m/lib/endpoint.js","node_modules/m2m/lib/m2m.js","node_modules/node-edge/lib/node-edge.js","node_modules/m2m/lib/supportLib.js"];function y(e){e?p.forEach(((t,n)=>{t.filename===e&&t.watcher.close()})):(p.forEach(((e,t)=>{e.watcher.close(),e.watcher._handle})),p=[])}function v(){l&&l.close()}let S={ctkpath:r,suspend:m,stopMonEpFS:y,stopMonEpApp:v,startMonEpFS:function(){try{let e=!0;function n(r){try{fs.readFileSync(r);let o=fs.watch(r,{persistent:!1},((o,s)=>{"change"===o&&(e=!1,y(r),f(r,"sf",s),t.logEvent("*unauthorized file system access",r),setTimeout(n,5e3,r))})),s={filename:r,watcher:o},i=!1;setTimeout((()=>{p.forEach(((e,t)=>{e.filename===r&&(e.watcher=o,i=!0)})),!1===i&&p.push(s)}),25)}catch(e){throw"watchNow fs.readFileSync error: "+e}}h.forEach(((e,t)=>{y(e),n(e)}))}catch(r){t.logEvent("startMonEpFS error:",r.message)}},startMonEpApp:function e(n){let r=!0;try{function o(n,r){v(),t.logEvent("*unauthorized ep application code access",n),f(n,"af",r),setTimeout((()=>e(n)),5e3)}fs.readFileSync(n),l=fs.watch(n,{persistent:!1},((e,t)=>{"change"===e&&r&&(r=!1,setImmediate(o,n,t))}))}catch(s){t.logEvent("startMonEpApp fs.readFileSync error:",s.message)}},stopMonExtFile:function(e,n){try{fs.statSync(e),g(e,s,n)}catch(e){t.logEvent("stopMonExtFile error:",e.message)}},closeAllWatcher:function(){s.forEach(((e,t)=>{e.fileWatcher.close()}))},startMonExtFile:function e(n,o){let l=!0,c=null,d=null,m=!1,p=null,h={fileWatcher:"",filename:""},y=Date.now();if("string"==typeof n)d=n,c=y+" "+d;else{if("object"!=typeof n)throw"startMonExtFile - invalid argument";n.filename&&(d=n.filename),n.fn&&(d=n.fn),c=y+" "+d,n.recursive&&"win32"===os.platform()&&(m=n.recursive),n.date&&(c=n.date+" "+d),n.id&&(c=n.id+" "+d)}try{fs.statSync(d)}catch(e){return console.log("startMonExtFile error:",e.message),function(e,n,o,s,i,a){try{let l="file or directory not found  "+s+" "+e.path;return 1===o[n]?(console.log(e.message,o[n]),o[n]++,i=s+" no such file or directory "+e.path,f(n,"wf",null,i),t.logEvent(l),t.logData(r+"watchLog.txt",l)):(o[n]||(o[n]=1,i=s+" no such file or directory "+e.path,t.logEvent(l),t.logData(r+"watchLog.txt",l)),o[n]++,30===o[n]&&(o[n]=1,i="")),i=s+" no such file or directory "+e.path,setTimeout((()=>f(n,"wf",null,i)),1e4),a?void a(i):i}catch(e){t.logEvent("monExtFileErrorHandler error:",e.message)}}(e.message,d,a,y,c,o)}function v(e){g(d,s,(n=>{try{t.logEvent("*file change detected",c),t.logData(r+"watchLog.txt","*file change detected",c),f(d,"wf",e,c),i[d]=c,o?setImmediate(o,c):(p.close(),setTimeout((()=>{i[d]=""}),1e3))}catch(e){t.logEvent("fileChangeAlert - closeExtWatchFile error:",e.message)}}))}return function(e,n){let r=u(e,n);if(!r||!r.result)return!1;try{return!0}catch(e){t.logEvent("remove monFile error:",e.message)}}(d,s)?i[d]:(function r(){try{p=fs.watch(d,{persistent:!1,recursive:m},((e,t)=>{"change"===e&&l&&"win32"===os.platform()?(l=!1,setImmediate(v,t)):!l||"rename"!==e&&"change"!==e||(l=!1,setImmediate(v,t))}))}catch(e){e&&t.logEvent("setFileWatcher error:",e.message)}p.on("close",(()=>{setTimeout((()=>{i[d]="",o?e(n,o):r()}),1e3)})),p.on("node-m2m-error",(e=>{t.logEvent("setFileWatcher error:",e.message)}))}(),h={fileWatcher:p,filename:d},p?(u((S=h).filename,w=s,((e,t,n)=>{if(e)throw e;t?w[n]=S:w.push(S)})),i[d]):void 0);var S,w},getSystemConfig:d,setSystemConfig:c};return S},manageFim=exports.manageFim=fimLib(m2mUtil),configLib=exports.configLib=function(e,t,n){let r=!1,o="https://www.node-m2m.com";const s=new RegExp(/\//),i=new RegExp(/\\/);let a=null,l=[];function c(t){try{if(t&&"object"!=typeof t)throw new Error("invalid arguments");if(t.m2mConfig&&t.m2mConfig.code&&"object"==typeof t.m2mConfig.code&&t.m2mConfig.code.allow&&t.m2mConfig.code.filename&&t.m2mConfig.code.filename.length>30)throw new Error("code filename is more than the maximum of 30 characters long");if(t.m2mConfig&&t.m2mConfig.code&&"object"!=typeof t.m2mConfig.code)throw new Error("code option must be an object");t.userSettings&&t.userSettings.name&&t.userSettings.name.length>20&&(t.userSettings.name=t.userSettings.name.slice(0,20)),t.userSettings&&t.userSettings.location&&t.userSettings.location.length>20&&(t.userSettings.location=t.userSettings.location.slice(0,20)),t.userSettings&&t.userSettings.description&&t.userSettings.description.length>20&&(t.userSettings.description=t.userSettings.description.slice(0,20))}catch(n){throw e.logEvent("validateUserOptions error:",t,JSON.stringify(n)),n}}function d(){t||(t=fimLib(e,dm)),t&&(t.startMonEpFS(),t.startMonEpApp(require.main.filename),e.logEvent("fim enabled - ep app & m2m system file"))}function m(){t&&(t.stopMonEpFS(),t.stopMonEpApp(),e.logEvent("fim disabled - ep app & m2m system file"))}function f(e){return r=e,r}function u(){return r}function g(){return t||(t=fimLib(e,dm)),{monFile:t.startMonExtFile,stopMonFile:t.stopMonExtFile,monitorFile:t.startMonExtFile,stopMonitorFile:t.stopMonExtFile}}return process.on("SIGINT",(e=>{console.log(""),n.emit("exit-process"),setTimeout((()=>process.exit()),200)})),{fim:g,setFim:g,defaultNode:o,setExitEvent:function(r){let o=Object.assign({},spl);delete o.options,delete o.systemInfo,delete o.sconfig,delete o.tid,delete o.ak,delete o.restartable,o._pid="exit",o.exit=!0,o.active=!1,function(r){let o="exit-process";n.listenerCount(o)<1&&n.once(o,(n=>{!function(n){const r="process exited ("+process.pid+")";e.logEvent(r,"");try{let e=t.getSystemConfig();e.fim&&(n.fim=!0,n.sconfig=e,n.item={af:!0,fn:options.processFilename},n._pid="fi-change",n.enable=!0),socket.send(n)}catch(e){console.log("executeExitEventProcess error:",e.message)}}(r)}))}(o),process.on("exit",(e=>console.log("")))},getPkgConfig:function(e){e.options||(e.options={});try{c(e.options);let t=!1,n=!1,r=!1,o=options.processFilename,a=s.test(o),l=i.test(o);function d(e,t){console.log("\nYou have a misconfigured package.json as shown below:"),console.log(e,t),console.log("\nYou can try fixing it by starting your application with -config flag.\n"),process.exit()}let m=require("../../../package.json");if(m){if(m.m2mConfig&&((l||a)&&(console.log("Your package.json m2mConfig filename is invalid =>",m.m2mConfig),console.log("\nPlease configure your package.json manually for code editing and auto start\n"),process.exit()),m.m2mConfig.code&&!1===m.m2mConfig.code.allow|!0&&m.m2mConfig.code.filename&&m.m2mConfig.code.filename===o&&(e.options.m2mConfig=m.m2mConfig,e.options.processFilename=o,t=!0),t||d("m2mConfig",m.m2mConfig)),m.nodemonConfig&&m.nodemonConfig.watch&&m.nodemonConfig.ignore&&("node_modules/m2m/mon"==m.nodemonConfig.watch[0]&&".git"===m.nodemonConfig.ignore[0]&&"public"===m.nodemonConfig.ignore[1]&&".git"===m.nodemonConfig.ignoreRoot[0]&&"public"===m.nodemonConfig.ignoreRoot[1]&&m.nodemonConfig.execMap.js&&"node"===m.nodemonConfig.execMap.js&&m.nodemonConfig.ext&&"js,json"===m.nodemonConfig.ext&&m.nodemonConfig.delay&&"2000"===m.nodemonConfig.delay&&(e.options.nodemonConfig=!0,n=!0),n||d("nodemonConfig",m.nodemonConfig)),m.scripts){let f={};if(m.scripts.start){e.options.startScript=m.scripts.start;let u=m.scripts.start;f=m.nodemonConfig.delay&&"2000"===m.nodemonConfig.delay?u.match("nodemon "+o):u.match("nodemon --delay 2000ms "+o),f&&f[0]&&(e.options.startScript=f[0],r=!0)}r||d("scripts",m.scripts)}return options&&e.options&&(options=e.options),e.options}}catch(g){g.code}},setPkgConfig:function(t){let n=null,r=null,o=null,a=null,l=null,c=options.processFilename,d=!1,m=!1,f=!1,u=i.test(c),g=s.test(c),p=c.indexOf("\\"),h=c.indexOf("/");try{if(u||g)return console.log("* package.json auto config failed"),void console.log("* Please configure manually your package.json");if(-1!==p||-1!==h)return console.log("** package.json auto config failed"),void console.log("** Please configure manually your package.json");if(t&&!t.options&&(t.options={}),n=fs.readFileSync("./node_modules/m2m/package.json"),o=fs.readFileSync("./package.json"),Buffer.isBuffer(o)&&(o=JSON.parse(o.toString())),"object"!=typeof o)throw new Error("Invalid package.json");if(0===Object.keys(o).length)throw new Error("Invalid package.json");a=fs.readFileSync("package.orig.json")}catch(e){n||(console.log("\nAuto config fail. Cannot find/resolve node_modules directory."),console.log("The package m2m requires that the node_modules directory must be\ninside the project's root directory.\n"),console.log("Please configure your package.json manually.\n"),process.exit()),o?fs.writeFileSync("package.orig.json",JSON.stringify(o,null,2)):(o={},o.name="m2m-application",o.version="1.0.0",o.dependencies={m2m:"^"+m2mv.version})}finally{try{console.log("\nConfiguring your package.json for m2m auto-restart ...\n"),o&&(o.name||(o.name="m2m-application"),o.version||(o.version="1.0.0")),o&&o.dependencies?o.dependencies.m2m="^"+m2mv.version:o.dependencies={m2m:"^"+m2mv.version},o.m2mConfig={code:{allow:!0,filename:c}},t.options.m2mConfig=o.m2mConfig,t.options.processFilename=c,d=!0,o.nodemonConfig={delay:"2000",verbose:!0,restartable:"rs",ignore:[".git","public"],ignoreRoot:[".git","public"],execMap:{js:"node"},watch:["node_modules/m2m/mon"],ext:"js,json"},t.options.nodeConfig=!0,t.options.nodemonConfig=!0,m=!0,l="nodemon "+c,o.scripts={},o.scripts.start=l,t.options.startScript=l,f=!0,fs.writeFileSync("package.json",JSON.stringify(o,null,2)),fs.readFileSync("./package.json"),d&&m&&f||(console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()),n=fs.readFileSync("./node_modules/m2m/package.json");try{r=fs.readFileSync("./node_modules/nodemon/package.json"),console.log("nodemon already installed.\n")}catch(t){r||(console.log("Installing nodemon ...\n"),"-config"!==e.argv[0]&&"-cp"!==e.argv[0]||spawnSync("npm i nodemon",{stdio:null,shell:!0}))}try{fs.readFileSync("./node_modules/m2m/package.json"),fs.readFileSync("./node_modules/nodemon/package.json"),e.logEvent("auto-restart package.json configuration - success")}catch(t){e.logEvent("setPkgConfig verify install error:",t.message),console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()}console.log(colors.brightGreen("Configuration done.")),setImmediate((()=>{o&&console.log("\nPlease verify the changes in your package.json."),a&&console.log("\nYou can revert to your original existing package.json\nusing the backup copy("+colors.brightGreen("package.orig.json")+")."),console.log("\nRestart your application using",colors.brightGreen("npm start")+".\n"),process.exit()}))}catch(t){e.logEvent("setPkgConfig error:",t.message)}}},setEpSecPolicy:function(r){try{let e=t.getSystemConfig(r);r.id&&(e.id=r.id),"server"==r.dst&&(e.server=r.dst),"client"==r.dst&&(e.client=r.dst),"user"==r.dst&&(e.user=r.dst),!0!==r.fim&&!1!==r.fim||(e.fim=r.fim,!0===e.fim?(d(),r.result=!0):!1===e.fim&&(e.ea=!1,e.ar=!1,m(),r.result=!0)),!0!==r.ea&&!1!==r.ea||(e.ea=r.ea),!0!==r.ar&&!1!==r.ar||(e.ar=r.ar),!0!==r.zta&&!1!==r.zta||(e.zta=r.zta),e=t.setSystemConfig(e),r.sc=e,setImmediate((()=>{n.emit("ws-emit-send",r)}))}catch(t){e.logEvent("setEpSecPolicy error:",t.message)}},setEnableStatus:f,getEnableStatus:u,getValidServers:()=>e.removeDuplicateInArray(l),setValidServers:t=>(l=e.removeDuplicateInArray(t),l),getCurrentServer:function(){return o},setCurrentServer:function(t){if(t&&"object"==typeof t){t&&(a=t);try{let n=e.decodeData(fs.readFileSync(sec.ecpath,"utf8"),"base64","embedded-credential");"object"==typeof n&&n.server&&(t=n)}catch(e){}if(!t.server)throw"setCurrentServer error: invalid/missing arg object server property";o=t.server}else t&&"string"==typeof t&&(o=t);return o},getUserResources:function(t,r,o){try{if(dm||(dm=dmLib(e)),t.active=!0,t.enable=u(),t.server&&o){if(t.startAccessRateMonitor)return dm.resources.startMonitorAccessRate(o,e);if(t.stopAccessRateMonitor)return dm.resources.stopMonitorAccessRate(e);t.getUserResources&&(o.serverSetup.id=t.id,t.serverSetup=o.serverSetup),t.serverTotalAccessRate=dm.resources.getserverAccessRateData(),r&&(t.clientAccessData=dm.resources.getClientAccessData(r))}else t.client&&r&&(t.clientAccessData=dm.resources.getClientAccessData(r));setImmediate((()=>{n.emit("ws-emit-send",t)}))}catch(t){e.logEvent("getUserResources error:",t.message)}},setActiveSyncData:function(e,t){try{if(t.length>0)for(let n=0;n<t.length;n++)if(t[n]&&e.name&&e.event&&t[n].id===e.id&&t[n].name===e.name)return!0;return t.push(e),!1}catch(e){logEvent("setDataEvent error:",e.message)}},setDefaultSecConfig:function(n){try{let e=t.getSystemConfig();0===Object.keys(e).length&&(e={id:n.id,src:n.src,enable:!0,fim:!1,ea:!1,ar:!1},t.setSystemConfig(e)),n.enable=e.enable,f(e.enable),!1===e.enable&&"r-ep"===pl_pid&&setTimeout((()=>{spl.server||n.server?console.log("\nServer is disabled\n"):spl.client||n.client?console.log("\nClient is disabled\n"):(spl.user||n.user)&&console.log("\nuser/edge is disabled\n")}),500)}catch(t){e.logEvent("setDefaultSecConfig error:",t.message)}},setInitEpSecPolicy:function(n){try{let e=t.getSystemConfig(n);Object.keys(n).length>0&&(!0!==n.enable&&!1!==n.enable||(e.enable=n.enable),!0!==n.fim&&!1!==n.fim||(e.fim=n.fim),!0!==n.ea&&!1!==n.ea||(e.ea=n.ea),!0!==n.ar&&!1!==n.ar||(e.ar=n.ar),!0!==n.zta&&!1!==n.zta||(e.zta=n.zta),e.fim?d():e.fim||m()),t.setSystemConfig(e)}catch(t){e.logEvent("startup setInitEpSecPolicy error:",t.message)}},validateUserOptions:c,getConnectionOptions:function(){return a}}},systemConfig=exports.systemConfig=configLib(m2mUtil,manageFim,emitter),secLib=exports.secLib=function(t,n,r,o){const s=[],i=1e6,a=/(\s)/g,l={regex:/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})*$/,msg:"Your userid must follow a valid email format."},c={regex:/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[^a-zA-Z0-9])(?!.*\s).{8,50}$/,msg:"Your password must be at least 8 characters long but not over 50 characters long.\nIt must have at least one number, one lowercase letter, one uppercase letter, and one special character."};let d={_sid:"ckm",_pid:null,rk:!0,nodev:process.version,m2mv:m2mv.version,rid:t.rid(4)},m=null,f=5e3,u=15,g={},p={},h=!0,y=null,v=null,S=0,w="",E="m2mConfig/sec/ec",b="m2mConfig/sec/tk",C=n.getSystemConfig();function x(){let e=t.rid(16),n=t.encodeData(e,"base64");return fs.writeFileSync(E,"s5Xc"+n+"cb7K"),n}function k(){try{return JSON.parse(Buffer.from(fs.readFileSync(b,"utf8"),"base64").toString("utf8"))}catch(e){return null}}function F(e,n){try{return fs.writeFileSync(e,n)}catch(e){t.logEvent("setCtk error:",e.message)}}function I(e){n&&(n.stopMonEpFS(),n.stopMonEpApp()),e.data&&F(e.path,e.data),e.result="success",e.restartable=!0,t.logEvent("process restarted remotely"),C.monFileStatus="m2m-restart-process",n.setSystemConfig(C)}"-rs"===processArgs[0]&&processArgs[1]&&(v=parseInt(processArgs[1]),Number.isInteger(v)&&(u=v),v>120&&(u=120)),function(){let e=require.main.filename,t=0;t="win32"===process.platform?e.lastIndexOf("\\"):e.lastIndexOf("/"),y=e.slice(t+1,t+50),options.processFilename=y}(),fs.mkdir(n.ctkpath,(e=>{e||function(){try{let e=x();fs.writeFileSync(b,"qR6t"+e+"r9Zn"),fs.writeFileSync("m2mConfig/sec/pk","b1rQ"+e+"zR3c"),fs.writeFileSync("m2mConfig/sec/ptk",Buffer.from(b).toString("base64"))}catch(e){t.logEvent("setSecTk error:",e.message)}}()}));let A=!1;function O(s){if(t.getRestartStatus())return;let i=null,a=null;try{i=fs.readFileSync("node_modules/m2m/package.json","utf8"),a=fs.readFileSync("node_modules/nodemon/package.json","utf8")}catch(e){t.logEvent("enableAutoRestartConfig fs.readFileSync error:",e.message)}if(!i)return void t.logEvent("enableAutoRestartConfig missing m2m module error:",e.message);let l=Math.floor(5e3*Math.random()+1e3);s.active=!0;try{t.getRestartStatus()?t.getRestartStatus()&&(C.monFileStatus="enable-auto-restart",n.setSystemConfig(C),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","enable-auto-restart")),l)):(0===Object.keys(options).length?r.setPkgConfig({}):Object.keys(options).length>0&&(options.m2mConfig&&options.processFilename&&options.nodemonConfig&&options.startScript||r.setPkgConfig({})),i&&!a&&spawnSync(s.cmd[1],s.option[0]),s.enable=r.getEnableStatus(),I(s),o.emit("ws-emit-send",s),setTimeout((()=>{spawnSync(s.cmd[2],s.option[1])}),l))}catch(e){t.logEvent("enableAutoRestartConfig error:",e.message)}}function j(e,n,r){let o=null;o="server"===e.dst?"m2m server":"client"===e.dst?"m2m client":"edge",S++,w=function(e){let t="";for(let e=0;e<72;e++)t+="=";return t}()+"\nCli tracking no : "+S+"\t"+new Date+"\nEndpoint id :  "+e.id+"\t\t|\tType :  "+o+"\t\t|\tContainerized :  "+t.systemInfo.container,fs.appendFileSync(e.filename,w+"\t\t\nCommand : "+e.cli+"\nResult :\n"),setTimeout((()=>{fs.appendFileSync(e.filename,n),e.brCliStore=s,L(e),setImmediate(r,e)}),500)}function D(e){try{e.pl=null,e.response=!0,o.emit("ws-emit-send",e)}catch(e){t.logEvent("processBrCli error:",e.message)}}function T(e,n){let r=!1;try{if(s.length>0)for(let t=0;t<s.length;t++)if(s[t]&&s[t].cmd&&e.cli&&s[t].cliId===e.cliId&&s[t].cmd===e.cli)return r=!0,e.completed=!0,n&&n(!0,t),setTimeout((()=>s.splice(t,1)),100);r||n&&n(!1)}catch(n){setTimeout((()=>{e.result="Command [ "+e.cli+" ] execution error. Please try again later.\n",t.logEvent("removeCliProcess error:",n.message),D(e)}),500)}}function N(e,n){try{let t=Buffer.from(e);n.uploadEventLog?n.eventLogData=t.toString("base64"):(n.uploadCliLog||n.scli)&&(n.cliLogData=t.toString("base64")),n.success=!0}catch(e){n.error="The was an error loading the log file. You can try again later.",t.logEvent("msgBundle error:",e.message)}finally{o.emit("ws-emit-send",n)}}function R(e,n){if("ENOENT"===e.code){let r="Endpoint id: "+n.id+"  -  Log file not found\n";return t.logEvent("logFileError:",r,e.message),N(r,n)}let r="Log file error";return t.logEvent("logFileError:",r,e.message),N(r,n)}function _(e,n){try{let t=w+"\nLog file has reached its max. allowable size.\nFile is truncated ...\n\n"+e.slice(-1e4);return fs.writeFileSync(n.filename,t),t}catch(e){t.logEvent("truncateLogFile error:",e.message)}}function L(e){try{let t=fs.readFileSync(e.filename,"utf8");t.length>i&&(t=_(t,e));let n=Buffer.from(t);e.cliLogData=n.toString("base64")}catch(t){R(t,e)}}function U(e,n){let o=null,s=null;try{o=r.getCurrentServer(),g.v=crypto.createVerify("SHA256"),g.v.update(r.defaultNode),g.v.end(),d._pid=e,d.node=r.defaultNode,m=setTimeout((()=>{console.log("\nThere was no response from the server.\nEither the server is down or you are connecting to an invalid server.\n"),process.kill(process.pid,"SIGINT")}),f)}catch(e){return console.log("getEpCk - node server certificate verification fail:",e.message),void t.logEvent("getEpCk crypto.createVerify error:",JSON.stringify(e))}if(o)try{let e=o.replace("https","wss");s=new _WebSocket(e+"/ckm",{origin:o})}catch(e){t.logEvent("getEpCk (invalid server) server.replace error:",JSON.stringify(e)),console.log("\nInvalid remote server address ...\nPlease confirm if you are connecting to a valid server.\n"),process.kill(process.pid,"SIGINT")}return"dck"===e&&(g.edh=crypto.createECDH("secp521r1"),g.edhpk=g.edh.generateKeys(),d.bk=g.edhpk.toString("base64")),s.on("open",(()=>{1===s.readyState&&s.send(JSON.stringify(d),(e=>{e&&t.logEvent("getEpCk ws open JSON.stringify(rkpl) send error:",JSON.stringify(e))}))})),s.on("error",(e=>{console.log(e),"Unexpected server response: 502"===e.message&&(console.log(colors.yellow("\nRemote server is not responding")," ...\nPlease try again later ...\n"),process.kill(process.pid,"SIGINT"))})),new Promise(((r,o)=>{s.on("message",(o=>{if(clearTimeout(m),1===s.readyState)try{o=JSON.parse(o),"dck"===e&&(g.vrfd=g.v.verify(o.puk,Buffer.from(o.bk,"base64")),g.vrfd&&(n?process.nextTick(n,null,o):r(o)))}catch(e){if(t.logEvent("getEpCk JSON.parse(ck) error:",JSON.stringify(e)),g=null,n)return n(e,null);r(e)}finally{s.close(),setTimeout((()=>o=null),3e3)}}))}))}function M(e,n){try{return e.dpk=n.puk,e.algo="aes-256-gcm",e.rnd=1e4,e.nk=Buffer.from(n.nk,"hex"),e.st=Buffer.from(n.st,"hex"),e.slt1=n.nk,e.slt2=n.st,e.csec=e.edh.computeSecret(Buffer.from(n.sk,"base64")),e.cipkey1=crypto.pbkdf2Sync(e.csec,e.slt1,e.rnd,32,"sha256"),e.cipkey2=crypto.pbkdf2Sync(e.csec,e.slt2,e.rnd,32,"sha256"),e}catch(r){throw t.logEvent("setEncKey error:",JSON.stringify(r)),e=null,n=null,r}}async function J(e,n,r){try{const s=await U("dck");if(g=M(g,s),e)if(g.uc={},g.at={},"string"==typeof e?g.uc=e:"object"==typeof e&&(e.name&&e.password?(g.uc.userid=e.name,g.uc.userpw=e.password,g.uc=JSON.stringify(g.uc)):g.uc=JSON.stringify(e)),"priv"===r){if(!g.cipkey1)throw new Error("invalid private key");g.at.aad=Buffer.from(t.rid(12),"hex"),g.cp=crypto.createCipheriv(g.algo,g.cipkey1,g.nk,{authTagLength:16}),g.cp.setAAD(g.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(g.uc))}),g.uc=g.cp.update(g.uc,"utf8"),g.cp.final(),g.at.tag=g.cp.getAuthTag(),n.euc=g.uc.toString("hex"),n.att=g.at.aad.toString("hex")+g.at.tag.toString("hex")}else{if("pub"!==r)throw new Error("invalid encryption type");if(!g.dpk)throw new Error("invalid public key");n.pd=crypto.publicEncrypt(g.dpk,Buffer.from(g.uc))}if(n.uid=g.slt1,n.idn=g.slt2,e.name&&e.password)return n;o.emit("ws-emit-send",n)}catch(e){throw t.logEvent("encryptData error:",JSON.stringify(e)),e}finally{setTimeout((()=>{g=null,n=null}),2e3)}}async function P(e,n,r,o,s){let i=null,a=null,d=Math.floor(5e3*Math.random()+1e3);if(r.aid&&n.sc){if(n.sc.length<6||n.sc.length>6)throw new Error("Invalid credential")}else if(n.name&&n.password){if(i=n.name.search(l.regex),a=n.password.search(c.regex),n.name.length<5||n.name.length>50)throw new Error("Userid must be 5 characters minimum and 50 characters maximum.");if(n.password.length<8||n.password.length>50)throw new Error("Password must be 8 characters minimum and 50 characters maximum.");if(0!==i&&0!==a)throw new Error("One of your credentials is invalid")}d<2e3&&!r.vsc?n.be=JSON.stringify({u:n.name,p:n.password,s:n.sc}):d>4e3&&!r.vsc?n.he=JSON.stringify({u:n.name,p:n.password,s:n.sc}):n.fe=JSON.stringify({u:n.name,p:n.password,s:n.sc});try{let i=await async function(e,n,r){try{if(e.be)n.be=Buffer.from(e.be).toString("base64"),n.uid=t.rid(8);else if(e.he)n.he=Buffer.from(e.he).toString("hex"),n.uid=t.rid(8);else if(e.fe){const r=await U("dck");g=M(g,r),e.name&&e.password&&(g.uc={},g.at={},g.uc.userid=e.name,g.uc.userpw=e.password,g.at.aad=Buffer.from(t.rid(12),"hex"),g.cp=crypto.createCipheriv(g.algo,g.cipkey1,g.nk,{authTagLength:16}),g.cp.setAAD(g.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(g.uc))}),g.ucs=g.cp.update(JSON.stringify(g.uc),"utf8"),g.cp.final(),g.at.tag=g.cp.getAuthTag(),n.euc=g.ucs.toString("hex"),n.att=g.at.aad.toString("hex")+g.at.tag.toString("hex")),e.sc&&(g.sc={},g.sccp=crypto.createCipheriv(g.algo,g.cipkey2,g.nk,{authTagLength:16}),g.sc.esc=g.sccp.update(e.sc,"utf8"),g.sccp.final(),g.sc.stag=g.sccp.getAuthTag(),n.esc=Buffer.from(JSON.stringify(g.sc),"utf8").toString("hex")),n.uid=g.slt1,n.idn=g.slt2}return n}catch(e){throw t.logEvent("encryptUser (system/process) error:",JSON.stringify(e)),e}finally{setTimeout((()=>{e=null,g=null,n=null}),2e3)}}(n,r);o.connect(e,i,s)}catch(e){throw t.logEvent("authenticate - encryptUser (system) error:",JSON.stringify(e)),"authenticate - encryptUser error"}}setTimeout((()=>{!function(){let e=Math.floor(5e3*Math.random()+1e3),r="m2m-module-update";o.listenerCount(r)<1&&o.on(r,(r=>{try{fs.readFileSync("./node_modules/m2m/package.json")}catch(e){return r.active=!0,r.error="Update fail. Cannot find/resolve node_modules directory.",delete r.file,delete r.code,o.emit("ws-emit-send",r),void t.logEvent("m2m module update error:",e.message)}if(r.aid===spl.aid){try{JSON.parse(r.file.package)}catch(e){return void t.logEvent("setModuleUpdateListener JSON.parse(rxd.file.package) error:",e.message)}n&&(n.stopMonEpFS(),n.stopMonEpApp());try{if(!r.path&&!r.file)return;r.file.endpoint&&r.path.endpoint&&fs.writeFileSync(r.path.endpoint,r.file.endpoint),r.file.m2m&&r.path.m2m&&fs.writeFileSync(r.path.m2m,r.file.m2m),r.file.supportLib&&r.path.supportLib&&fs.writeFileSync(r.path.supportLib,r.file.supportLib),r.file.nodeEdge&&r.path.nodeEdge&&fs.writeFileSync(r.path.nodeEdge,r.file.nodeEdge),r.file.package&&r.path.package&&fs.writeFileSync(r.path.package,r.file.package),setImmediate((()=>{r.active=!0,r.update="success",t.getRestartStatus()&&(r.restartable=!0),delete r.file,delete r.path,o.emit("ws-emit-send",r),t.logEvent("m2m module updated","v"+r.ver),r.restartable&&setTimeout((()=>{C.monFileStatus="m2m-module-update",n.setSystemConfig(C),fs.writeFileSync("node_modules/m2m/mon","m2m-module-update")}),e)}))}catch(e){t.logEvent("setModuleUpdateListener fs.writeFileSync(path.client, client) error:",e)}}}))}()}),100);const B=e=>!!e.match(l.regex)||l.msg,q=e=>e.match(c.regex)?!e.match(a)||"Contains white space":c.msg,z=e=>!(e.length<6||e.length>6)||"Invalid security code",W=e=>e.match("^(http|https)://|[a-z0-9]+([-.]{1}[a-z0-9]+)*.[a-z]{2,6}(:[0-9]{1,5})?(/.*)?$/ix")?!e.match(a)||"Your server property must not contain any white space.":"Invalid server property. It must follow a valid domain name.";function Y(e,n,r,o){let s=[];n._pid="r-ep",n.tid=Date.now(),s.push({type:"input",message:"Enter your userid (email):",name:"name",validate:B}),s.push({type:"password",message:"Enter your password:",name:"password",mask:"*",validate:q}),n.aid&&(n.at="sc")&&(s=[{type:"password",message:"*Enter your security code:",name:"sc",mask:"*",validate:z}],n.vsc=!0),console.log("\nPlease provide your credentials ...\n"),inquirer.prompt(s).then((t=>{if(n.aid&&t.sc){if(t.sc.length<6||t.sc.length>6)throw new Error("Invalid credential");n._pid="v-ep",n.sc=t.sc,process.nextTick(r.connect,e,n,o)}else P(e,t,n,r,o)})).catch((e=>{e.isTtyError?t.logEvent("userPrompt - inquirer error.isTtyError:",JSON.stringify(e)):t.logEvent("userPrompt - inquirer error:",JSON.stringify(e))}))}function G(e,t,n,r){let o={_sid:"m2m"};return o.id=e,o.srcId=e,o[t]=!0,o[n]=o[t],o.src=t,o._pid=r,o.active=!0,o.enable=!0,o.at="pu",o.type=t,"server"===t&&(o.serverId=e),"server"===t?o.serverId=e:"client"===t?o.clientId=e:"user"===t?o.userId=e:"endpoint"===t&&(o.endpointId=e),o}function H(e,n){try{let r=t.rid(4),o=k();if(n&&(o=null),e&&!e.options&&(e.options={}),e.arg&&"object"==typeof e.arg&&e&&e.options&&(e.options.userSettings=e.arg),e.ep){if(o&&o.ep)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=G(r,"endpoint","e","r-e");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.server){if(o&&o.id!==e.id&&(o=null),o&&o.server)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=G(e.id,"server","d","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.client){if(o&&o.client)return o.options=e.options,e.edgeEp?o.edgeEp=e.edgeEp:e.edgeUser&&(o.edgeUser=e.edgeUser),o;{const t=G(r,"client","c","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.user||e.edgeEp||e.edgeUser){if(o&&o.user)return o.options=e.options,o;{const t=G(r,"user","u","r-ep");return e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t.options=e.options,t}}}catch(e){console.log("getEndpoint error:",e.message)}}function K(){let e=n.getSystemConfig();e.monFileStatus="reset",n.setSystemConfig(e)}async function Z(e,n,r,o){if(K(),"-r"!==processArgs[0])try{if(n=H(n),e&&"object"==typeof e){try{let r=fs.readFileSync(E,"utf8");if(!r)throw"empty";let o=t.decodeData(r,"base64","embedded-credential");if(!o||"object"!=typeof o)throw"invalid ec";"***"===e.pw?(n.id===o.id||(o.id=n.id,F(E,t.encodeData(o,"base64"))),e=o):(n=H(n,!0),x())}catch(e){n=H(n,!0),x()}if(n.aid)process.nextTick(r.connect,e,n,o);else{e.trial&&(n.trial=e.trial,n.startDate=Date.now());let t=function(e,t){try{e.sc&&(console.log("\nPlease use only the userid and pw combination for your credential.\n"),process.exit(1)),e.server||(console.log("\nInvalid credential.\nYou have a missing server property in your credential.\n"),process.exit(1)),t.aid;let n={},r=null,o=null,s=null,i=null;return e.userid&&e.pw?(r=B(e.userid),o=q(e.pw),s=W(e.server),!0===r&&!0===o&&!0===s?(n.name=e.userid,n.password=e.pw):(!0!==r?(console.log("\nInvalid credential:",e.userid+"\n"),console.log(r)):!0!==o?(console.log("\nInvalid credential:",e.pw+"\n"),console.log(o)):!0!==s&&(console.log("\nInvalid credential:",e.server+"\n"),console.log(s)),console.log(""),process.exit(1))):e.sc?(i=z(e.sc),!0===i?(t.aid||(console.log("\nPlease provide userid and pw properties in your embedded credentials.\n"),process.exit()),n.sc=e.sc):(console.log("\nInvalid credentials\n"),process.exit(1))):(console.log("\nInvalid credential.\nYou have a missing userid or pw property in your credential.\n"),process.exit(1)),{arg:e,user:n,pl:t}}catch(e){console.log("validateEmbeddedArg error:",e.message),process.exit(1)}}(e,n);P(t.arg,t.user,t.pl,r,o)}return}Y(e,n,r,o)}catch(e){throw new Error("m2mStart error:",e.message)}else Y(e,n=H(n,!0),r,o)}function V(e,n,r,o,s){try{if(console.log("\n"),n.client&&r.id&&"number"==typeof r.id)return console.log("Endpoint has changed from server to client, please register the new client."),Z(e,n,o,s);if(n.client&&r.client&&r.clientId&&r.clientId!==n.clientId)return console.log("Client id has changed from",r.id,"to",n.id,"please register the new client."),Z(e,n,o,s);if(n.client&&r.user)return console.log("Endpoint has changed from user to client, please register the new client."),Z(e,n,o,s);if(n.server&&r.client&&r.id&&"string"==typeof r.id)return console.log("Endpoint has changed from client to server, please register the new server."),Z(e,n,o,s);if(n.server&&r.user&&r.id&&"string"==typeof r.id)return console.log("Endpoint has changed from user to server, please register the new server."),Z(e,n,o,s);if(n.server&&r.id&&r.id!==n.id)return console.log("Server id has changed from",r.id,"to",n.id,", please register the new server."),Z(e,n,o,s);if(n.server&&!r.id)return console.log("Registering new server.\n"),Z(e,n,o,s);if(n.edgeUser&&(r.server||r.client))return console.log("Endpoint type has changed to edge, please register the new edge."),Z(e,n,o,s);if(n.user&&(r.server||r.client))return console.log("Endpoint type has changed to user, please register the new user."),Z(e,n,o,s);if(!(n.server||n.client||n.user||n.endpoint)){if(r.user)return console.log("Register new endpoint.\n"),Z(e,n,o,s);console.log("Verifying existing endpoint."),r._pid="r-e"}process.nextTick(o.connect,e,r,s)}catch(e){t.logEvent("validateCtkn error:",JSON.stringify(e))}}function $(e,s,i){try{e.options=options,e.systemInfo=t.systemInfo,e.active=!0,e.enable=r.getEnableStatus(),e.containerized=t.systemInfo.container;let a=n.getSystemConfig(e);a&&(e.sc=a),t.getRestartStatus()&&(e.restartable=!0),e.status&&"client"===e.dst?(dm||(dm=dmLib(t)),dm&&s&&(e.clientserverId=r.getValidServers(),e.clientAccessData=dm.resources.getClientAccessData(s))):e.status&&"server"===e.dst?i&&i.serverSetup&&(e.serverSetup=i.serverSetup):(e.status&&"user"===e.dst||e.status&&"edge"===e.dst)&&edge;try{let t=fs.readFileSync("./node_modules/m2m/package.json","utf8");if(t){let n=JSON.parse(t);e.systemInfo.m2mv="v"+n.version}}catch(e){console.log("readFileSync pkgJson error:",e.message)}setImmediate((()=>{o.emit("ws-emit-send",e)}))}catch(e){t.logEvent("getEndpointStatus error:",e.message)}}return{decSC:function(e,n){if(p&&Object.keys(p).length>0)try{return p.dec=crypto.createCipheriv(p.algo,p.cipkey2,p.nk,{authTagLength:16}),p.decData=p.dec.update(e.edata,"hex","utf8"),p.decData+=p.dec.final("utf8"),n?n(null,p.decData):p.decData}catch(e){if(t.logEvent("decSC error:",JSON.stringify(e)),n)return n(e,null);throw e}finally{setTimeout((()=>{e=null,p=null}),2e3)}},ecpath:E,setCtk:F,readCtk:k,m2mStart:Z,m2mRestart:function(e,t,r,o){let s=H(t),i=n.getSystemConfig(),a=null,l=!1;try{a=JSON.parse(Buffer.from(fs.readFileSync(b,"utf8"),"base64").toString("utf8")),"object"==typeof a&&(l=!0)}catch(e){l=!1}s.aid||l?!s.aid&&l?V(e,s,a,r,o):s.aid&&l&&(e&&"object"==typeof e&&e.server?V(e,s,a,r,o):i.zta?(s.at="sc",Z(e,s,r,o)):process.nextTick(r.connect,e,s,o)):Z(e,s,r,o)},userPrompt:Y,autoRestart:function(e){try{C.monFileStatus="auto-restart",n.setSystemConfig(C),e.server?fs.writeFileSync("node_modules/m2m/mon","auto-restart"):setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","auto-restart")),1e3)}catch(e){t.logEvent("autoRestart error:",e.message)}},validateArg:function(e,n){if(e&&"string"!=typeof e&&e&&"object"==typeof e)try{let n=t.decodeData(fs.readFileSync(E,"utf8"),"base64","embedded-credential");if(!n||"object"!=typeof n)throw"invalid ec";e=n}catch(r){!function(e,n){if(!e||"string"==typeof e)return;let r=require.main.filename,o=fs.readFileSync(r,"utf8");o=o.split(" ").join("");let s=o.indexOf("connect({");if(s<0)throw"invalid embedded argument";let i=o.indexOf("sc",s),a=o.indexOf("pw",s),l=o.indexOf("userid",s),c=o.indexOf("server",s),d=null,m=null,f=null,u=null,g=null,p=null;if(i>0&&c>i&&(console.log("sc precedes the server"),console.log("\nPlease ensure the server property\nprecedes the sc property.\n"),process.exit()),l>0&&a>0){if(a>c&&l>c?(a>l?(m=o.indexOf(",",l+8),d=o.indexOf("}",a+4)):(d=o.indexOf(",",a+4),m=o.indexOf("}",l+8)),f=o.indexOf(",",c+8)):(a>l?(m=o.indexOf(",",l+8),d=o.indexOf(",",a+4)):(d=o.indexOf(",",a+4),m=o.indexOf(",",l+8)),f=o.indexOf("}",c+8)),g=o.slice(l+8,m-1),u=o.slice(a+4,d-1),p=o.slice(c+8,f-1),"***"===u)return;if(e.userid!==g)throw"invalid userid";if(e.pw!=u)throw"invalid pw";if(e.server!==p)throw"invalid server";n&&n.id&&(e.id=n.id,e.valid=!0);let s=t.encodeData(e,"base64");F(E,s),setTimeout((()=>{let e=fs.readFileSync(r,"utf8").replaceAll(g,"***");fs.writeFileSync(r,e)}),100),setTimeout((()=>{let e=fs.readFileSync(r,"utf8").replaceAll(u,"***");fs.writeFileSync(r,e)}),150)}}(e,n)}},rxCommonData:function(e,a,l,c){try{if(e.restart)return c&&c.accessEp(e),function(e){if(A)return;let n=null,s=null;try{try{n=fs.readFileSync("node_modules/m2m/mon"),s=fs.readFileSync("./node_modules/m2m/package.json")}catch(r){return e.active=!0,n||(e.error="Update fail. Cannot find/resolve monitor file."),s||(e.error="Update fail. Cannot find/resolve node_modules directory."),o.emit("ws-emit-send",e),void t.logEvent("restart error:",r.message)}let i=Math.floor(5e3*Math.random()+1e3);e.active=!0,e.result="fail",e.restartable=!1,e.enable=r.getEnableStatus(),o.emit("ws-emit-send",e),t.getRestartStatus()&&(I(e),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","m2m-restart-process")),i)),A=!0}catch(e){t.logEvent("restartProcess error:",e.message)}}(e);if(e.status)$(e,a,l);else if(e.secureSystem)!function(e){try{e.active=!0,e.on&&(h=!1),e.result="success",t.logEvent("process","secure system enabled"),o.emit("ws-emit-send",e)}catch(e){t.logEvent("secureSystem error:",e.message)}}(e);else if(e.updateCode)!function(e){e.active=!0;try{if(!e.appData)return e.appData="filename does not exist.",e.error={permission:!0,file:null},o.emit("ws-emit-send",e);if(e.updateCode&&Object.keys(options).length>0&&options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow){if(options.m2mConfig.code.filename){t.getRestartStatus()&&(e.restartable=!0),n&&n.stopMonEpApp();let r=Buffer.from(e.appData,"base64").toString("utf8");return!1===r.includes("require('m2m')",0)?void t.logEvent("updateCode error:remote browser app code is not in utf8 format"):fs.writeFile(options.m2mConfig.code.filename,r,(r=>{if(r)return"ENOENT"===r.code?e.appData="filename does not exist.":e.appData=r,t.logEvent("application code update error:",r.message),e.error={permission:!0,file:null},o.emit("ws-emit-send",e);delete e.appData,e.success=!0,o.emit("ws-emit-send",e),n&&n.startMonEpApp(options.m2mConfig.code.filename),t.logEvent("application code updated",options.m2mConfig.code.filename),setImmediate((()=>{C.monFileStatus="app-code-update",n.setSystemConfig(C),fs.writeFileSync("node_modules/m2m/mon","app-code-update")}))}))}return e.error={permission:!0,file:null},t.logEvent("updateCode missing filename error:",options.m2mConfig),o.emit("ws-emit-send",e)}return e.error={permission:!1},t.logEvent("updateCode missing options.m2mConfig.code error:",options),o.emit("ws-emit-send",e)}catch(e){t.logEvent("updateCode error:",e.message)}}(e);else if(e.uploadCode)!function(e){e.active=!0;try{if(e.uploadCode&&Object.keys(options).length>0)return options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow&&options.m2mConfig.code.filename?(e.processFilename=options.m2mConfig.code.filename,function(e,n){let s=r.getConnectionOptions();fs.readFile(e,"utf8",((e,r)=>{try{if(e)return"ENOENT"===e.code?n.appData="filename does not exist.":n.appData=e,n.error={permission:!1,file:null},o.emit("ws-emit-send",n);let t=Buffer.from(r);if(s&&s.pw&&"***"!==s.pw)return n.error={pw:!0,permission:!1,file:null},o.emit("ws-emit-send",n);n.success=!0,n.enc?J(r,n,"priv"):(n.appData=t.toString("base64"),o.emit("ws-emit-send",n))}catch(e){t.logEvent("getCodeData error:",e.message)}}))}(options.m2mConfig.code.filename,e)):(e.error={permission:!0,file:null},o.emit("ws-emit-send",e));e.error={permission:!1},o.emit("ws-emit-send",e)}catch(e){t.logEvent("uploadCode error:",e.message)}}(e);else if(e.moduleUpdate)o.emit("m2m-module-update",e);else if(e.uploadCliLog)!function(e){e.active=!0,e.uploadCliLog&&function(e){try{let t=fs.readFileSync(e.filename,"utf8");if(t.length>i)return N(_(t,e),e);if(e.enc)return J(t,e,"priv");N(t,e)}catch(t){R(t,e)}}(e)}(e);else if(e.clearCliLog)!function(e){e.active=!0;try{t.rid(4),fs.readFileSync(e.filename,"utf8"),setTimeout((()=>{(e.clearCliLog||e.clearEventLog)&&(function(e){let n="";e.clearEventLog&&(n=t.eventLogHeader);try{fs.writeFileSync(e.filename,n),e.success=!0;let t="Endpoint id : "+e.id+"  -  log file is empty\n\n";fs.appendFileSync(e.filename,t),S=0}catch(t){return R(t,e)}}(e),L(e),o.emit("ws-emit-send",e))}),300)}catch(n){t.logEvent("clearLogFile error:",n.message),e.error="Cannot clear log file",o.emit("ws-emit-send",e)}}(e);else if(e.acli)!function(e){e.success=!0,T(e,((n,r)=>{try{n?(s[r].cli.kill("SIGSTOP"),s[r].cli.killed?j(e,"Aborted\n\n",D):j(e,"Abort fail\n\n",D)):j(e,"Already executed, nothing to abort\n\n",D)}catch(e){t.logEvent("aCli error:",e.message)}}))}(e);else if(e.scli){if(e.ers)return c&&c.accessEp(e),void O(e);!function(e){try{if(function(e){let t=Object.assign({},e);t.pl=null,t.ack=!0,t.response=!0,o.emit("ws-emit-send",t)}(e),e.ers)return O(e);!function(e,n,r){let o=null,i="",a=null;try{e.opt&&(a=e.opt);let l=spawn(n,{stdio:a,shell:!0}),c={cli:l,cmd:e.cli,pid:l.pid,killed:l.killed,cliId:e.cliId};s.push(c),n=null,e.success=!0,"win32"!==process.platform&&(o=setTimeout((()=>{i+=e.crp,T(e),j(e,i+"\n",r)}),5e3),l.stdout.on("data",(e=>{i+=e.toString(),clearTimeout(o)})),l.stderr.on("data",(e=>{let t=e.toString().search("no password was provided"),n=e.toString().search("password for");-1===t&&-1===n&&(i+=e.toString())}))),l.on("close",((t,n)=>{clearTimeout(o),n&&(i+="Command aborted\n"),e.code=t,T(e),j(e,i+"\n",r)})),l.on("exit",((e,t)=>{})),l.on("node-m2m-error",(n=>{t.logEvent("cli execution error:",n.toString()),j(e,i+"error: "+n.toString()+"\n",r)})),l.stdin.end()}catch(n){t.logEvent("exeBrCli error:",n.message),j(e,"Execution error. Please try again later.\n\n",r)}}(e,t.decodeData(e.pl,"base64"),(e=>{D(e)}))}catch(e){t.logEvent("eCli error:",e.message)}}(e)}else e.setEpSec?r.setEpSecPolicy(e):e.suspend?n.suspend(e,l):e.getUserResources||e.startAccessRateMonitor||e.stopAccessRateMonitor?r.getUserResources(e,a,l):(e.accessEdge||e.edgeResources)&&c&&c.accessEp(e)}catch(e){t.logEvent("rxCommonData error:",e.message)}},setFimConfig:K,verifyTestCode:function(e){10===e.code&&e.reason},getCurrentProcessName:function(){return y}}},sec=exports.sec=secLib(m2mUtil,manageFim,systemConfig,emitter);exports.dataManager=dm,exports.fimManager=manageFim,exports.emitter=emitter;
