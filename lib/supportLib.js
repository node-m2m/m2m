/*!
 * supportLib.js
 * v2.4.4
 *
 * Copyright(c) 2020 Ed Alegrid
 *
 */
"use strict";const _WebSocket=require("ws"),colors=require("colors"),inquirer=require("inquirer"),m2mv=require("../package.json"),fs=require("fs"),os=require("os"),ip=require("ip"),crypto=require("crypto"),{spawn:spawn,spawnSync:spawnSync,execFileSync:execFileSync}=require("child_process"),processArgs=process.argv.slice(2);let spl={},socket=null,options={};function showAlert(){console.log("\n***",colors.brightYellow("M2M Module Warning!"),"***"),console.log("The node_modules directory is not inside the project's root directory."),console.log("The m2m module requires that the node_modules directory is inside\nthe project's root directory. This will allow the remote endpoint to access"),console.log("all the available features of node-m2m.")}exports.setLibDefaults=function(e,t){e&&(spl=e),t&&(socket=t)};let nmp1="./node_modules/m2m/package.json",nmp2="../node_modules/m2m/package.json",node_module_path=null;try{fs.readFileSync(nmp1),node_module_path=nmp1}catch(e){showAlert(),fs.readFileSync(nmp2),node_module_path=nmp2}exports.m2mUtilLib=function(e){const t=/^[A-Za-z0-9-_\/]*$/,n=/^[A-Za-z0-9 \[\]"{}':,._-]*$/;let o=null,r="m2mConfig/sec/",s=r+"ptk",i=r+"tk",a=r+"pk",c=process.pid,l=null,m=null,u=!1,f="m2mConfig/eLog",d=35e3,g="                  Date                                           Event";function p(e,t){fs.mkdir("m2mConfig/",(n=>{try{if(n)throw n;e?fs.writeFileSync(e,g):fs.writeFileSync(f,g),t&&t()}catch(e){if("EEXIST"!==e.code)throw console.log("initLog error:",n.message),e.message}}))}function h(e,t,n,o,r,s,i,a,c,l){try{r||(r=""),s||(s=""),i||(i=""),a||(a=""),c||(c=""),l||(l=""),function(e,t,n,o,r,s,i,a,c,l){fs.open(e,"r",((t,m)=>{t&&"ENOENT"===t.code&&fs.writeFileSync(e,g);try{fs.appendFileSync(e,"\n"+n+"  "+o+"  "+r+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(t){throw t}})),fs.stat(e,((m,u)=>{if(m&&"ENOENT"===m.code&&p(),u&&u.size>t)try{fs.writeFileSync(e,g),fs.appendFileSync(e,"\n"+n+"  "+o+"  "+r+"  "+s+"  "+i+"  "+a+"  "+c+"  "+l)}catch(m){throw m}}))}(e,t,n,o,r,s,i,a,c,l)}catch(e){throw e}}function y(e,t,n,o,r,s,i){let a=new Date,c=a.toDateString()+" "+a.toLocaleTimeString();h(f,d,c,e,t,n,o,r,s,i)}function v(){fs.mkdir(r,(e=>{e||function(){try{fs.writeFileSync(s,i),fs.writeFileSync(a,"node-m2m")}catch(e){y("setSecTk - fs.writeFileSync error:",e.message)}}()}))}u=!("start"!==process.env.npm_lifecycle_event&&!process.env.npm_package_nodemonConfig_restartable),p(),y("process starting pid","("+process.pid+")"),v(),o="linux"===os.platform()?execFileSync("npm",["-v"]):"win32"===os.platform()?execFileSync("npm -v",{shell:!0}):execFileSync("npm",["-v"]);const S={nodev:process.version,npmv:o.toString("utf8"),type:os.arch(),mem:{total:(os.totalmem()/1e6).toFixed(0)+" MB",free:(os.freemem()/1e6).toFixed(0)+" MB"},m2mv:"v"+m2mv.version,os:os.platform(),container:function(){try{return!(c.toString().length>1||(y("process running in container",!0),0))}catch(e){y("isContainer error:",e.message)}}(),ip:ip.address()};function E(){return l=new Date,l}return E(),{st:E,et:function(){return m=new Date,m-l+" ms"},rid:function(e){return crypto.randomBytes(e).toString("hex")},secTkn:{getPtk:function(){return s},getRtk:function(){return i},getRpk:function(){return a},initSec:v,setToBuffer:function(e,t){try{if("base64"===t)return Buffer.from(JSON.stringify(e)).toString("base64");if("hex"===t)return Buffer.from(JSON.stringify(e)).toString("hex")}catch(e){y("setToBuffer error:",e.message)}}},m2mInfo:function(e,t){try{console.log("\n********************************************"),console.log("   m2m ver:",m2mv.version),console.log("   os:",process.platform),console.log("   h/w type:",os.arch()),e.server?(console.log("   endpoint: server"),e.id&&console.log("   id:",e.id)):e.client?(console.log("   endpoint: client"),e.clientId&&console.log("   id:",e.clientId)):e.edgeUser&&e.user?(console.log("   endpoint: edge (user)"),e.userId&&console.log("   id:",e.userId)):e.user&&!e.edgeUser&&(console.log("   endpoint: user"),e.userId&&console.log("   id:",e.userId)),console.log("   m2m server:",colors.brightBlue(t),"\n********************************************")}catch(e){y("m2mInfo error:",e.message)}},logData:function(e,t,n,o,r,s,i,a){let c=new Date,l=c.toDateString()+" "+c.toLocaleTimeString();h(e,d,l,t,n,o,r,s,i,a)},logEvent:y,setError:function(t,n,o){let r=new Error(t);if(y("error:",r.message),e.emit("node-m2m-error",r),n)n({error:r.message});else{if(!o)throw r;o(r)}},systemInfo:S,getUrlKeys:function(e,t){let n=null;const o=[],r=[],s={};t.startsWith("/")||m2mUtil.setError(new Error("path: "+e.name+" - invalid url path, it must begin with a slash /"),null,null);let i=t.indexOf("?",1);-1!==i&&(n=t.substring(i+1,t.length)),new URLSearchParams(n).forEach((function(e,t){s[t]=e}));let a=t.indexOf("?");-1!==a&&(t=t.slice(0,a));for(let e=0;e<t.length;e++)"/"===t[e]&&o.push(e);return o.forEach(((e,n)=>{try{if(0==e&&o[n+1]){let e=t.slice(o[n],o[n+1]);r.push(e)}else if(0!==e&&o[n]&&o[n+1]){let e=t.slice(o[n],o[n+1]);r.push(e)}else{let e=t.slice(o[n],t.length);r.push(e)}}catch(e){m2mUtil.logEvent("urlRoutesIndex.forEach error:",e.message)}})),e.urlPathKeys=r,e.baseUrl=r[0],e.query=s,e},getSubTopic:function(e,t){const n=[],o=[];if(!t.startsWith("/"))return e;if(t.includes("?"))throw t+" - invalid topic attribute";for(let e=0;e<t.length;e++)("/"===t[e]||"#"===t[e])&&n.push(e);n.forEach((function(e,r){if(0===e&&n[r+1]){let e=t.slice(n[r],n[r+1]);o.push(e)}else if(0!==e&&n[r]&&n[r+1]){let e=t.slice(n[r],n[r+1]);o.push(e)}else{let e=t.slice(n[r],t.length);o.push(e)}}));let r={};o[0]===t&&1===o.length&&(r.root=o[0]);let s=o[0].length,i=t.slice(s);return e.topicKeys=o,e.baseTopic=o[0],e.subTopic=i,e.rootTopic=r.root,e},getParamKeys:function(e){const t={},n=[],o=[],r={},s=[];for(let t=0;t<e.length;t++)"/"===e[t]&&n.push(t);return n.forEach(((t,r)=>{if(0==t&&n[r+1]){let t=e.slice(n[r],n[r+1]);o.push(t)}else if(0!==t&&n[r]&&n[r+1]){let t=e.slice(n[r],n[r+1]);o.push(t)}else{let t=e.slice(n[r],e.length);o.push(t)}})),o.forEach(((e,t)=>{if(e.startsWith("/:")){let n=e.slice(2,e.length),o={key:n,index:t};r[n]=n,s.push(o)}})),t.urlPathKeys=o,t.baseUrl=o[0],t.params=r,t.paramKeys=s,t.rootPath=o[0],t},startConnect:function(t,n){let o="emit-connect";t&&t.resetServerSetup(),e.listenerCount(o)<1&&e.on(o,(e=>{if(n||console.log(e),n)if(n.length>0){if(Array.isArray(e))return n("registration fail");setImmediate(n,e)}else{if(Array.isArray(e))return console.log("registration fail");console.log("connection:",e),setImmediate(n)}}))},setDataEvent:function(e,t){try{if(t.length>0)for(let n=0;n<t.length;n++)if(t[n]&&e.name&&e.event&&t[n].id===e.id&&t[n].name===e.name)return!0;return t.push(e),!1}catch(e){y("setDataEvent error:",e.message)}},eventLogHeader:g,getRestartStatus:function(){return u},setEpErrorEvent:function(t,n){if("error"!==t)throw new Error(t+" event name is invalid");let o="node-m2m-"+t;e.listenerCount(o)<1&&e.on(o,(e=>{if("object"==typeof e)return n(e);"string"==typeof e&&n(e)}))},argv:processArgs,validateNameAndPayload:function(e){let o=!0,r=null,s=null;try{if(!e)return void y("validateNameAndPayload !arg:",JSON.stringify(e));if(Array.isArray(e)&&(s=e[0]),s&&(e=s),e.name&&("string"!=typeof e.name&&(o=null),e.name.length>75&&(o=null),e.name.match(t),!o))throw new Error("invalid channel/path");if((e.payload||e.body)&&(e.payload?r=e.payload:e.body&&(r=e.body),"number"==typeof r||"object"==typeof r||"string"==typeof r||(o=null)),r&&(r=JSON.stringify(r),r&&r.length>500&&(o=null),r&&r.match(n),!o))throw e.payload&&(e.payload=null,y("write/sendData - invalid payload data",r)),e.body&&(e.body=null,y("post - invalid body data",r)),new Error("invalid payload/body");return o}catch(e){throw y("validateNameAndPayload error:",e.message),e}},removeDuplicateInArray:function(e){return Array.from(new Set(e))},validateClientApi:function(e,t,n,o,r,s,i,a){let c={};if("string"==typeof e&&r&&("function"==typeof t&&(i=t,"watch"===s&&(o=5e3)),"function"==typeof n&&(i=n),"function"==typeof o&&(i=o,Number.isInteger(t)&&(o=t)),"write"!==s&&"sendData"!==s&&"post"!==s||(n=t),t=e,e=r),Number.isInteger(e)?(c.id=e,"string"==typeof t&&("get"===s||"post"===s?c.path=t:c.channel=t),"number"!=typeof n&&"string"!=typeof n&&"object"!=typeof n||("post"===s?c.body=n:"write"!==s&&"sendData"!==s||(c.payload=n)),"function"==typeof o&&(i=o,o=5e3),Number.isInteger(o)&&(c.interval=o)):"object"==typeof e&&(i=t,r&&(e.id=r),"watch"===s&&(e.interval||(e.interval=5e3)),"function"==typeof t&&(i=t),c=e),!c.id)throw console.log(c),new Error("validateClientApi error - missing id");if("get"===s||"post"===s){if(!c.path)throw console.log(c),new Error("validateClientApi error - missing path")}else if(c.topic);else if(!c.channel)throw console.log(c),new Error("validateClientApi error - missing channel");if("post"===s){if(!c.body)throw console.log(c),new Error("validateClientApi error - missing body")}else if(("write"===s||"sendData"===s)&&!c.payload)throw console.log(c),new Error("validateClientApi error - missing payload");if("watch"===s&&!c.interval)throw console.log(c),new Error("validateClientApi error - missing interval");return new Promise((function(e,t){"function"==typeof i&&(e=null,t=null),a(c,s,i,e,t)}))},removeDuplicateObjectInArray:e=>{if(!Array.isArray(e))return y("filterArray invalid array input:",""+e),!1;try{return e.filter(((t,n)=>n===e.findIndex((e=>t.title===e.title))))}catch(e){y("filterArray error:",e.message)}}}};const dmLib=exports.dmLib=e=>{let t=[],n=1,o={},r=!0,s=null,i=1,a=!1,c=[],l=[],m=[],u=[],f=[],d=[],g=[],p=[],h=[],y={},v=[];function S(e,t){let n="m2mConfig/ar",o="base64",r="utf8";try{if("r"===e){let e=fs.readFileSync(n,"utf8");e&&(y=JSON.parse(Buffer.from(e,o).toString(r)))}else if("w"===e&&Object.keys(y).length>0&&y.accessRateData&&y.accessRateData[0]){let e=JSON.stringify(y),t=Buffer.from(e,r).toString(o);fs.writeFileSync(n,t)}}catch(e){}}function E(e){i=1,r=!1,c=[],l=[],m=[],u=[],f=[],d=[],g=[],p=[],h=[],y={},y.accessCounter=1,y.monStatus=!1,clearTimeout(s)}function w(e,t){e.forEach(((e,n)=>{let o={id:spl.id,name:e,cpm:0,tcpm:0,arpm:0};t.push(o)}))}function b(e){e.forEach(((e,t)=>{e.tcpm=e.tcpm+e.cpm,e.arpm=(e.tcpm/i).toFixed(n),e.iteration=i;let o=Object.assign({},e);e.tcpm&&h.push(o),e.cpm=0}))}function C(t){r=!0,y.monStatus=!0,t&&(o=t.resources.getserverResources());let n=o.publish.name,a=o.dataSource.name,k=o.get.path,F=o.post.path;1===i&&(w(n,c),w(a,l),w(k,m),w(F,u)),h=[],s=setTimeout((()=>{r=!1,clearTimeout(s),v.forEach(((t,n)=>{try{t.name&&t.watch&&"watch"===t.method?c.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.watch=!0)})):t.name&&t.getData&&"getData"===t.method?l.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.getData=!0)})):t.name&&t.sendData&&"sendData"===t.method?l.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.sendData=!0)})):t.name&&t.read&&"read"===t.method?l.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.read=!0)})):t.name&&t.write&&"write"===t.method?l.forEach(((e,n)=>{e.name===t.name&&(e.cpm++,e.write=!0)})):t.name&&t.get&&"get"===t.method?m.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.get=!0)})):t.name&&t.post&&"post"===t.method&&u.forEach(((e,n)=>{e.name!==t.name&&e.name!==t.baseUrl||(e.cpm++,e.post=!0)}))}catch(t){e&&e.logEvent("accessRateMonitoring error:",t.message)}})),b(c),b(l),b(m),b(u),b(f),b(d),b(g),b(p),setImmediate((()=>{y={accessRateData:h,monStatus:!0,accessCounter:i},v=[],setTimeout((()=>{i<60?(S("w"),i++,C(t)):(E(),S("w"),setTimeout((()=>{C(t)}),25))}),1e3)}))}),6e4)}function k(t,n){return t.push("&nbsp"+n),e.removeDuplicateInArray(t)}return{resources:{collectAccessData:function(e){r&&v.push(e)},getClientAccessData:function(n){return a?t:function(n){let o=function(e){let t=[],n=e.getValidServers();return e.getClientRawAccessData().forEach((e=>{n.includes(e.id)&&t.push(e)})),t}(n);return o.forEach((n=>function(n){let o=!1,r=e.systemInfo.ip,s={id:n.id,clientId:n.clientId,ip:r,sub:[],read:[],write:[],get:[],post:[],inputGetState:[],inputWatch:[],outputGetState:[],outputOn:[],outputOff:[]};t.forEach(((e,t)=>{e.id===n.id&&(o=!0)})),!1===o&&t.push(s)}(n))),t.forEach(((t,n)=>{o.forEach(((n,o)=>{try{t.id===n.id&&(n.getData&&n.name?t.read=k(t.read,n.name):n.sendData&&n.name?t.write=k(t.write,n.name):n.read&&n.name?t.read=k(t.read,n.name):n.write&&n.name?t.write=k(t.write,n.name):n.watch&&n.name?t.sub=k(t.sub,n.name):n.get&&n.name?t.get=k(t.get,n.name):n.post&&n.name?t.post=k(t.post,n.name):n.gpioInput&&n.watch&&n.pin?t.inputWatch=k(t.inputWatch,n.pin):n.gpioInput&&n.getState&&n.pin?t.inputGetState=k(t.inputGetState,n.pin):n.gpioOutput&&n.pin&&(n.getState||"state"===n.output)?t.outputGetState=k(t.outputGetState,n.pin):n.gpioOutput&&n.on&&n.pin?t.outputOn=k(t.outputOn,n.pin):n.gpioOutput&&n.off&&n.pin&&(t.outputOff=k(t.outputOff,n.pin)))}catch(t){e&&e.logEvent("processRequestResourcesData error:",t.message)}}))})),a=!0,t}(n)},stopMonitorAccessRate:E,startMonitorAccessRate:function(e,t){S("r"),r=!0,setImmediate(C,e)},getserverAccessRateData:function(){return y},resetserverAccessRateData:function(){y={}}}}},fimLib=exports.fimLib=(t,n)=>{let o=null,r=[],s=[],i=[],a="m2mConfig/",c="m2mConfig/scfg/sconfig",l=!0;function m(e){let n={};try{return n=Buffer.from(JSON.stringify(e)).toString("base64"),fs.writeFileSync(c,n),n}catch(e){return t.logEvent("setSystemConfig error:",e.message),n}}function u(e){let n={};e&&e.path&&(c=e.path);try{n=JSON.parse(Buffer.from(fs.readFileSync(c,"utf8"),"base64").toString())}catch(e){"ENOENT"!==e.code&&t.logEvent("getSystemConfig JSON.parse scpath1 error:",e.message),fs.mkdirSync("m2mConfig/scfg",{recursive:!0})}return n}function f(e,o){try{let r=u();!1===e.enable?(l=!1,r.enable=!1,console.log("disable"),o&&o.stopWatchServices(),n&&n.resources.stopMonitorAccessRate(t),t.logEvent("Endpoint is disabled")):!0===e.enable&&(l=!0,r.enable=!0,console.log("enable"),o&&o.startWatchServices(),n&&o&&n.resources.startMonitorAccessRate(o,t),t.logEvent("Endpoint is enabled")),m(r)}catch(e){t.logEvent("suspend error:",e.message)}}function d(n,o,r,s){try{let i=u();if(i.fim){let a=Object.assign({},spl);a.fim=!0,a._pid="fi-change",a.restartable=t.getRestartStatus(),fs.readFileSync(n),a.filename=t.secTkn.setToBuffer(n,"base64"),a.item={},"af"===o?a.item.af=!0:"sf"===o?a.item.sf=!0:"wf"===o&&(a.item.wf=!0),r&&(a.item.fn=r),s&&(a.result=s),a.stdFim=!0,(i.ar||i.ar1||i.ar2)&&(i.enable=!1,a.enable=!1),a.sconfig=i,socket.send(a),function(n){n||t.logEvent("startActiveResponse error:",e.message),n.ar&&f({enable:!1}),n.ar1&&process.kill(process.pid,"SIGINT"),n.ar2}(i)}}catch(e){e.code,t.logEvent("FimResponse - getSystemConfig error:",e.message)}}function g(e,n,o){try{if(n.length>0)for(let t=0;t<n.length;t++)if(n[t]&&n[t].filename&&e&&n[t].filename===e)return o?void o(null,!0,t):{result:!0,x:t};return!!o&&void o(null,!1)}catch(e){o&&o(e),t.logEvent("findFileName error:",e.message)}}function p(e,n,o){g(e,n,((e,r,s)=>{if(e)throw e;if(r)try{n[s].fileWatcher.close(),n.splice(s,1),o&&o(!0)}catch(e){t.logEvent("closeExtWatchFile - findFileName error:",e.message)}}))}let h=[],y=["node_modules/m2m/lib/endpoint.js","node_modules/m2m/lib/m2m.js","node_modules/node-edge/lib/node-edge.js","node_modules/m2m/lib/supportLib.js"];function v(e){e?h.forEach(((t,n)=>{t.filename===e&&t.watcher.close()})):(h.forEach(((e,t)=>{e.watcher.close(),e.watcher._handle})),h=[])}function S(){o&&o.close()}let E={suspend:f,stopMonEpFS:v,stopMonEpApp:S,startMonEpFS:function(){try{let e=!0;function n(o){try{fs.readFileSync(o);let r=fs.watch(o,{persistent:!1},((r,s)=>{"change"===r&&(e=!1,v(o),d(o,"sf",s),t.logEvent("*unauthorized file system access",o),setTimeout(n,5e3,o))})),s={filename:o,watcher:r},i=!1;setTimeout((()=>{h.forEach(((e,t)=>{e.filename===o&&(e.watcher=r,i=!0)})),!1===i&&h.push(s)}),25)}catch(e){throw"watchNow fs.readFileSync error: "+e}}y.forEach(((e,t)=>{v(e),n(e)}))}catch(o){t.logEvent("startMonEpFS error:",o.message)}},startMonEpApp:function e(n){let r=!0;try{function s(n,o){S(),t.logEvent("*unauthorized ep application code access",n),d(n,"af",o),setTimeout((()=>e(n)),5e3)}fs.readFileSync(n),o=fs.watch(n,{persistent:!1},((e,t)=>{"change"===e&&r&&(r=!1,setImmediate(s,n,t))}))}catch(i){t.logEvent("startMonEpApp fs.readFileSync error:",i.message)}},stopMonExtFile:function(e,n){try{fs.statSync(e),p(e,r,n)}catch(e){t.logEvent("stopMonExtFile error:",e.message)}},closeAllWatcher:function(){r.forEach(((e,t)=>{e.fileWatcher.close()}))},startMonExtFile:function e(n,o){let c=!0,l=null,m=null,u=!1,f=null,h={fileWatcher:"",filename:""},y=Date.now();if("string"==typeof n)m=n,l=y+" "+m;else{if("object"!=typeof n)throw"startMonExtFile - invalid argument";n.filename&&(m=n.filename),n.fn&&(m=n.fn),l=y+" "+m,n.recursive&&"win32"===os.platform()&&(u=n.recursive),n.date&&(l=n.date+" "+m),n.id&&(l=n.id+" "+m)}try{fs.statSync(m)}catch(e){return console.log("startMonExtFile error:",e),function(e,n,o,r,s,i){try{let c="file or directory not found  "+r+" "+e.path;return 1===o[n]?(console.log(e.message,o[n]),o[n]++,s=r+" no such file or directory "+e.path,d(n,"wf",null,s),t.logEvent(c),t.logData(a+"watchLog.txt",c)):(o[n]||(o[n]=1,s=r+" no such file or directory "+e.path,t.logEvent(c),t.logData(a+"watchLog.txt",c)),o[n]++,30===o[n]&&(o[n]=1,s="")),s=r+" no such file or directory "+e.path,setTimeout((()=>d(n,"wf",null,s)),1e4),i?void i(s):s}catch(e){t.logEvent("monExtFileErrorHandler error:",e.message)}}(e.message,m,i,y,l,o)}function v(e){p(m,r,(n=>{try{t.logEvent("*file change detected",l),t.logData(a+"watchLog.txt","*file change detected",l),d(m,"wf",e,l),s[m]=l,o?setImmediate(o,l):(f.close(),setTimeout((()=>{s[m]=""}),1e3))}catch(e){t.logEvent("fileChangeAlert - closeExtWatchFile error:",e.message)}}))}return function(e,n){let o=g(e,n);if(!o||!o.result)return!1;try{return!0}catch(e){t.logEvent("remove monFile error:",e.message)}}(m,r)?s[m]:(function r(){try{f=fs.watch(m,{persistent:!1,recursive:u},((e,t)=>{"change"===e&&c&&"win32"===os.platform()?(c=!1,setImmediate(v,t)):!c||"rename"!==e&&"change"!==e||(c=!1,setImmediate(v,t))}))}catch(e){e&&t.logEvent("setFileWatcher error:",e.message)}f.on("close",(()=>{setTimeout((()=>{s[m]="",o?e(n,o):r()}),1e3)})),f.on("node-m2m-error",(e=>{t.logEvent("setFileWatcher error:",e.message)}))}(),h={fileWatcher:f,filename:m},f?(g((S=h).filename,E=r,((e,t,n)=>{if(e)throw e;t?E[n]=S:E.push(S)})),s[m]):void 0);var S,E},getSystemConfig:u,setSystemConfig:m};return E};exports.configLib=function(e,t,n,o,r){let s=!1,i="https://www.node-m2m.com";const a=new RegExp(/\//),c=new RegExp(/\\/);let l=null;function m(t){try{if(t&&"object"!=typeof t)throw new Error("invalid arguments");if(t.m2mConfig&&t.m2mConfig.code&&"object"==typeof t.m2mConfig.code&&t.m2mConfig.code.allow&&t.m2mConfig.code.filename&&t.m2mConfig.code.filename.length>30)throw new Error("code filename is more than the maximum of 30 characters long");if(t.m2mConfig&&t.m2mConfig.code&&"object"!=typeof t.m2mConfig.code)throw new Error("code option must be an object");t.userSettings&&t.userSettings.name&&t.userSettings.name.length>20&&(t.userSettings.name=t.userSettings.name.slice(0,20)),t.userSettings&&t.userSettings.location&&t.userSettings.location.length>20&&(t.userSettings.location=t.userSettings.location.slice(0,20)),t.userSettings&&t.userSettings.description&&t.userSettings.description.length>20&&(t.userSettings.description=t.userSettings.description.slice(0,20))}catch(n){throw e.logEvent("validateUserOptions error:",t,JSON.stringify(n)),n}}function u(){n||(n=fimLib(e,t)),n&&(n.startMonEpFS(),n.startMonEpApp(require.main.filename),e.logEvent("fim enabled - ep app & m2m system file"))}function f(){n&&(n.stopMonEpFS(),n.stopMonEpApp(),e.logEvent("fim disabled - ep app & m2m system file"))}function d(e){return s=e,s}function g(){return s}function p(){return n||(n=fimLib(e,t)),{monFile:n.startMonExtFile,stopMonFile:n.stopMonExtFile,monitorFile:n.startMonExtFile,stopMonitorFile:n.stopMonExtFile}}return{fim:p,setFim:p,defaultNode:i,getPkgConfig:function(e){e.options||(e.options={});try{m(e.options);let t=!1,n=!1,r=!1,s=o.processFilename,i=a.test(s),l=c.test(s);function u(e,t){console.log("\nYou have a misconfigured package.json as shown below:"),console.log(e,t),console.log("\nYou can try fixing it by starting your application with -config flag.\n"),process.exit()}let f=require("../../../package.json");if(f){if(f.m2mConfig&&((l||i)&&(console.log("Your package.json m2mConfig filename is invalid =>",f.m2mConfig),console.log("\nPlease configure your package.json manually for code editing and auto start\n"),process.exit()),f.m2mConfig.code&&!1===f.m2mConfig.code.allow|!0&&f.m2mConfig.code.filename&&f.m2mConfig.code.filename===s&&(e.options.m2mConfig=f.m2mConfig,e.options.processFilename=s,t=!0),t||u("m2mConfig",f.m2mConfig)),f.nodemonConfig&&f.nodemonConfig.watch&&f.nodemonConfig.ignore&&("node_modules/m2m/mon"==f.nodemonConfig.watch[0]&&".git"===f.nodemonConfig.ignore[0]&&"public"===f.nodemonConfig.ignore[1]&&".git"===f.nodemonConfig.ignoreRoot[0]&&"public"===f.nodemonConfig.ignoreRoot[1]&&f.nodemonConfig.execMap.js&&"node"===f.nodemonConfig.execMap.js&&f.nodemonConfig.ext&&"js,json"===f.nodemonConfig.ext&&f.nodemonConfig.delay&&"2000"===f.nodemonConfig.delay&&(e.options.nodemonConfig=!0,n=!0),n||u("nodemonConfig",f.nodemonConfig)),f.scripts){let d={};if(f.scripts.start){e.options.startScript=f.scripts.start;let g=f.scripts.start;d=f.nodemonConfig.delay&&"2000"===f.nodemonConfig.delay?g.match("nodemon "+s):g.match("nodemon --delay 2000ms "+s),d&&d[0]&&(e.options.startScript=d[0],r=!0)}r||u("scripts",f.scripts)}return options&&e.options&&(options=e.options),e.options}}catch(p){p.code}},setPkgConfig:function(t){let n=null,r=null,s=null,i=null,l=null,m=o.processFilename,u=!1,f=!1,d=!1,g=c.test(m),p=a.test(m),h=m.indexOf("\\"),y=m.indexOf("/");try{if(g||p)return console.log("* package.json auto config failed"),void console.log("* Please configure manually your package.json");if(-1!==h||-1!==y)return console.log("** package.json auto config failed"),void console.log("** Please configure manually your package.json");if(t&&!t.options&&(t.options={}),n=fs.readFileSync("./node_modules/m2m/package.json"),s=fs.readFileSync("./package.json"),Buffer.isBuffer(s)&&(s=JSON.parse(s.toString())),"object"!=typeof s)throw new Error("Invalid package.json");if(0===Object.keys(s).length)throw new Error("Invalid package.json");i=fs.readFileSync("package.orig.json")}catch(e){n||(console.log("\nAuto config fail. Cannot find/resolve node_modules directory."),console.log("The package m2m requires that the node_modules directory must be\ninside the project's root directory.\n"),console.log("Please configure your package.json manually.\n"),process.exit()),s?fs.writeFileSync("package.orig.json",JSON.stringify(s,null,2)):(s={},s.name="m2m-application",s.version="1.0.0",s.dependencies={m2m:"^"+m2mv.version})}finally{try{console.log("\nConfiguring your package.json for m2m auto-restart ...\n"),s&&(s.name||(s.name="m2m-application"),s.version||(s.version="1.0.0")),s&&s.dependencies?s.dependencies.m2m="^"+m2mv.version:s.dependencies={m2m:"^"+m2mv.version},s.m2mConfig={code:{allow:!0,filename:m}},t.options.m2mConfig=s.m2mConfig,t.options.processFilename=m,u=!0,s.nodemonConfig={delay:"2000",verbose:!0,restartable:"rs",ignore:[".git","public"],ignoreRoot:[".git","public"],execMap:{js:"node"},watch:["node_modules/m2m/mon"],ext:"js,json"},t.options.nodeConfig=!0,t.options.nodemonConfig=!0,f=!0,l="nodemon "+m,s.scripts={},s.scripts.start=l,t.options.startScript=l,d=!0,fs.writeFileSync("package.json",JSON.stringify(s,null,2)),fs.readFileSync("./package.json"),u&&f&&d||(console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()),n=fs.readFileSync("./node_modules/m2m/package.json");try{r=fs.readFileSync("./node_modules/nodemon/package.json"),console.log("nodemon already installed.\n")}catch(t){r||(console.log("Installing nodemon ...\n"),"-config"!==e.argv[0]&&"-cp"!==e.argv[0]||spawnSync("npm i nodemon",{stdio:null,shell:!0}))}try{fs.readFileSync("./node_modules/m2m/package.json"),fs.readFileSync("./node_modules/nodemon/package.json"),e.logEvent("auto-restart package.json configuration - success")}catch(t){e.logEvent("setPkgConfig verify install error:",t.message),console.log(colors.brightRed("Configuration fail")+". Please configure your package.json manually."),e.logEvent("auto-restart package.json configuration - fail"),process.exit()}console.log(colors.brightGreen("Configuration done.")),setImmediate((()=>{s&&console.log("\nPlease verify the changes in your package.json."),i&&console.log("\nYou can revert to your original existing package.json\nusing the backup copy("+colors.brightGreen("package.orig.json")+")."),console.log("\nRestart your application using",colors.brightGreen("npm start")+".\n"),process.exit()}))}catch(t){e.logEvent("setPkgConfig error:",t.message)}}},setEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);t.id&&(e.id=t.id),"server"==t.dst&&(e.server=t.dst),"client"==t.dst&&(e.client=t.dst),"user"==t.dst&&(e.user=t.dst),!0!==t.fim&&!1!==t.fim||(e.fim=t.fim,!0===e.fim?(u(),t.result=!0):!1===e.fim&&(e.ea=!1,e.ar=!1,f(),t.result=!0)),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e=n.setSystemConfig(e),t.sc=e,setImmediate((()=>{r.emit("ws-emit-send",t)}))}catch(t){e.logEvent("setEpSecPolicy error:",t.message)}},setEnableStatus:d,getEnableStatus:g,setExitEvent:function(t){let s=Object.assign({},spl);delete s.options,delete s.systemInfo,delete s.sconfig,delete s.tid,delete s.ak,delete s.restartable,s._pid="exit",s.exit=!0,s.active=!1,function(t){let s="exit-process";r.listenerCount(s)<1&&r.once(s,(r=>{!function(t){const r="process exited ("+process.pid+")";e.logEvent(r,"");try{let e=n.getSystemConfig();e.fim&&(t.fim=!0,t.sconfig=e,t.item={af:!0,fn:o.processFilename},t._pid="fi-change",t.enable=!0),socket.send(t)}catch(e){console.log("executeExitEventProcess error:",e.message)}}(t)}))}(s),process.on("SIGINT",(e=>{r.emit("exit-process"),setTimeout((()=>process.exit()),200)})),process.on("exit",(e=>console.log("")))},getCurrentServer:function(){return i},setCurrentServer:function(e){return e&&"object"==typeof e?e&&e.server&&(i=e.server):e&&"string"==typeof e&&(i=e),e&&(l=e),i},setDefaultSecConfig:function(t){try{let e=n.getSystemConfig();0===Object.keys(e).length&&(e={id:t.id,src:t.src,enable:!0,fim:!1,ea:!1,ar:!1},n.setSystemConfig(e)),t.enable=e.enable,d(e.enable),!1===e.enable&&"r-ep"===pl_pid&&setTimeout((()=>{spl.server||t.server?console.log("\nServer is disabled\n"):spl.client||t.client?console.log("\nClient is disabled\n"):(spl.user||t.user)&&console.log("\nuser/edge is disabled\n")}),500)}catch(t){e.logEvent("setDefaultSecConfig error:",t.message)}},getUserResources:function(n,o,s){try{if(t||(t=dmLib(e)),n.active=!0,n.enable=g(),n.server&&n.getUserResources)if(n.startAccessRateMonitor){if(t&&s)return t.resources.startMonitorAccessRate(s,e)}else if(n.stopAccessRateMonitor){if(t)return t.resources.stopMonitorAccessRate(e)}else n.getUserResources&&(s&&(s.serverSetup.id=n.id,n.serverSetup=s.serverSetup),t&&(n.serverTotalAccessRate=t.resources.getserverAccessRateData()));else n.client&&n.getUserResources&&t&&o&&(n.clientAccessData=t.resources.getClientAccessData(o));setImmediate((()=>{r.emit("ws-emit-send",n)}))}catch(t){e.logEvent("getUserResources error:",t.message)}},setInitEpSecPolicy:function(t){try{let e=n.getSystemConfig(t);Object.keys(t).length>0&&(!0!==t.enable&&!1!==t.enable||(e.enable=t.enable),!0!==t.fim&&!1!==t.fim||(e.fim=t.fim),!0!==t.ea&&!1!==t.ea||(e.ea=t.ea),!0!==t.ar&&!1!==t.ar||(e.ar=t.ar),!0!==t.zta&&!1!==t.zta||(e.zta=t.zta),e.fim?u():e.fim||f()),n.setSystemConfig(e)}catch(t){e.logEvent("startup setInitEpSecPolicy error:",t.message)}},validateUserOptions:m,getConnectionOptions:function(){return l}}},exports.secLib=function(t,n,o,r,s){const i=[],a=1e6,c={regex:/^([a-zA-Z0-9._%-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6})*$/,msg:"Invalid userid. It must follow a valid email format."},l={regex:/^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*()\\[\]{}\-_+=~|:;<>,./? ])(?=.{6,})/,msg:"Password must be at least 8 characters long but not over 50 characters long.\nIt must have at least one number, one lowercase letter, one uppercase letter, and one special character."};let m={_sid:"ckm",_pid:null,rk:!0,nodev:process.version,m2mv:m2mv.version,rid:t.rid(4)},u=null,f=5e3,d=15,g={},p={},h=!0,y=t.secTkn.getPtk(),v=(t.secTkn.getRtk(),t.secTkn.getRpk(),null),S=null,E=n.getSystemConfig();function w(){try{return fs.readFileSync(y,"utf8").slice(0,27)}catch(e){"ENOENT"===e.code&&t.secTkn.initSec()}}function b(){let e=null;try{return e=JSON.parse(Buffer.from(fs.readFileSync(w(),"utf8"),"base64").toString("utf8")),e}catch(t){return e}}function C(e,n){try{return fs.writeFileSync(e,n)}catch(e){t.logEvent("setCtk error:",e.message)}}function k(r){if(t.getRestartStatus())return;let s=null,i=null;try{s=fs.readFileSync("node_modules/m2m/package.json","utf8"),i=fs.readFileSync("node_modules/nodemon/package.json","utf8")}catch(e){t.logEvent("enableAutoRestartConfig fs.readFileSync error:",e.message)}if(!s)return void t.logEvent("enableAutoRestartConfig missing m2m module error:",e.message);let a=Math.floor(5e3*Math.random()+1e3);r.active=!0;try{t.getRestartStatus()?t.getRestartStatus()&&(E.monFileStatus="enable-auto-restart",n.setSystemConfig(E),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","enable-auto-restart")),a)):(0===Object.keys(options).length?o.setPkgConfig({}):Object.keys(options).length>0&&(options.m2mConfig&&options.processFilename&&options.nodemonConfig&&options.startScript||o.setPkgConfig({})),s&&!i&&spawnSync(r.cmd[1],r.option[0]),setTimeout((()=>{spawnSync(r.cmd[2],r.option[1])}),a))}catch(e){t.logEvent("enableAutoRestartConfig error:",e.message)}}function F(){return new Date}function x(e){let t="";for(let n=0;n<e;n++)t+="=";return t}"-rs"===processArgs[0]&&processArgs[1]&&(S=parseInt(processArgs[1]),Number.isInteger(S)&&(d=S),S>120&&(d=120)),function(){let e=require.main.filename,t=0;t="win32"===process.platform?e.lastIndexOf("\\"):e.lastIndexOf("/"),v=e.slice(t+1,t+50),s.processFilename=v}();let A=x(60)+"\n"+F()+"\n"+x(60);function O(e,t,n){A=x(60)+"\n"+F()+"\nEndpoint id: "+e.id,fs.appendFileSync(e.filename,A+"\ncommand [ "+e.cli+" ]\n"),setTimeout((()=>{fs.appendFileSync(e.filename,t),e.brCliStore=i,function(e){let t=null;try{t=fs.readFileSync(e.filename,"utf8"),t.length>a&&(t=D(t,e));let n=Buffer.from(t);e.cliLogData=n.toString("base64")}catch(t){N(t,e)}}(e),setImmediate(n,e)}),500)}function I(e){try{"server"===e.dst?e.src="server":"client"===e.dst?e.src="client":"user"===e.dst&&(e.src="user"),e.dst="browser",e.response=!0,e.pl=null,socket.send(e)}catch(e){t.logEvent("processBrCli error:",e.message)}}function T(e,n){let o=!1;try{if(i.length>0)for(let t=0;t<i.length;t++)if(i[t]&&i[t].cmd&&e.cli&&i[t].cliId===e.cliId&&i[t].cmd===e.cli)return o=!0,e.completed=!0,n&&n(!0,t),setTimeout((()=>i.splice(t,1)),100);o||n&&n(!1)}catch(n){setTimeout((()=>{e.result="Command [ "+e.cli+" ] execution error. Please try again later.\n",t.logEvent("removeCliProcess error:",n.message),I(e)}),500)}}function j(e,n){try{let t=Buffer.from(e);n.uploadEventLog?n.eventLogData=t.toString("base64"):(n.uploadCliLog||n.scli)&&(n.cliLogData=t.toString("base64")),n.success=!0}catch(e){n.error="The was an error loading the log file. You can try again later.",t.logEvent("msgBundle error:",e.message)}finally{r.emit("ws-emit-send",n)}}function N(e,n){if("ENOENT"===e.code){let o="Endpoint id: "+n.id+"  -  Log file not found\n";return t.logEvent("logFileError:",o,e.message),j(o,n)}let o="Log file error";return t.logEvent("logFileError:",o,e.message),j(o,n)}function D(e,n){try{let t=A+"\nLog file has reached its max. allowable size.\nFile is truncated ...\n\n"+e.slice(-1e4);return fs.writeFileSync(n.filename,t),t}catch(e){t.logEvent("truncateLogFile error:",e.message)}}function R(e,n){let r=null,s=null;try{r=o.getCurrentServer(),g.v=crypto.createVerify("SHA256"),g.v.update(o.defaultNode),g.v.end(),m._pid=e,m.node=o.defaultNode,u=setTimeout((()=>{console.log("\nThere was no response from the server.\nEither the server is down or you are connecting to an invalid server.\n"),process.kill(process.pid,"SIGINT")}),f)}catch(e){return console.log("getEpCk - node server certificate verification fail:",e.message),void t.logEvent("getEpCk crypto.createVerify error:",JSON.stringify(e))}if(r)try{let e=r.replace("https","wss");s=new _WebSocket(e+"/ckm",{origin:r})}catch(e){t.logEvent("getEpCk (invalid server) server.replace error:",JSON.stringify(e)),console.log("\nInvalid remote server address ...\nPlease confirm if you are connecting to a valid server.\n"),process.kill(process.pid,"SIGINT")}return"dck"===e&&(g.edh=crypto.createECDH("secp521r1"),g.edhpk=g.edh.generateKeys(),m.bk=g.edhpk.toString("base64")),s.on("open",(()=>{1===s.readyState&&s.send(JSON.stringify(m),(e=>{e&&t.logEvent("getEpCk ws open JSON.stringify(rkpl) send error:",JSON.stringify(e))}))})),s.on("error",(e=>{console.log(e),"Unexpected server response: 502"===e.message&&(console.log(colors.yellow("\nRemote server is not responding")," ...\nPlease try again later ...\n"),process.kill(process.pid,"SIGINT"))})),new Promise(((o,r)=>{s.on("message",(r=>{if(clearTimeout(u),1===s.readyState)try{r=JSON.parse(r),"dck"===e&&(g.vrfd=g.v.verify(r.puk,Buffer.from(r.bk,"base64")),g.vrfd&&(n?process.nextTick(n,null,r):o(r)))}catch(e){if(t.logEvent("getEpCk JSON.parse(ck) error:",JSON.stringify(e)),g=null,n)return n(e,null);o(e)}finally{s.close(),setTimeout((()=>r=null),3e3)}}))}))}function _(e,n){try{return e.dpk=n.puk,e.algo="aes-256-gcm",e.rnd=1e4,e.nk=Buffer.from(n.nk,"hex"),e.st=Buffer.from(n.st,"hex"),e.slt1=n.nk,e.slt2=n.st,e.csec=e.edh.computeSecret(Buffer.from(n.sk,"base64")),e.cipkey1=crypto.pbkdf2Sync(e.csec,e.slt1,e.rnd,32,"sha256"),e.cipkey2=crypto.pbkdf2Sync(e.csec,e.slt2,e.rnd,32,"sha256"),e}catch(o){throw t.logEvent("setEncKey error:",JSON.stringify(o)),e=null,n=null,o}}async function M(e,n,o){try{const s=await R("dck");if(g=_(g,s),e)if(g.uc={},g.at={},"string"==typeof e?g.uc=e:"object"==typeof e&&(e.name&&e.password?(g.uc.userid=e.name,g.uc.userpw=e.password,g.uc=JSON.stringify(g.uc)):g.uc=JSON.stringify(e)),"priv"===o){if(!g.cipkey1)throw new Error("invalid private key");g.at.aad=Buffer.from(t.rid(12),"hex"),g.cp=crypto.createCipheriv(g.algo,g.cipkey1,g.nk,{authTagLength:16}),g.cp.setAAD(g.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(g.uc))}),g.uc=g.cp.update(g.uc,"utf8"),g.cp.final(),g.at.tag=g.cp.getAuthTag(),n.euc=g.uc.toString("hex"),n.att=g.at.aad.toString("hex")+g.at.tag.toString("hex")}else{if("pub"!==o)throw new Error("invalid encryption type");if(!g.dpk)throw new Error("invalid public key");n.pd=crypto.publicEncrypt(g.dpk,Buffer.from(g.uc))}if(n.uid=g.slt1,n.idn=g.slt2,e.name&&e.password)return n;r.emit("ws-emit-send",n)}catch(e){throw t.logEvent("encryptData error:",JSON.stringify(e)),e}finally{setTimeout((()=>{g=null,n=null}),2e3)}}async function L(e,n,o,r,s){let i=null,a=null,m=(Math.floor(5e3*Math.random()+1e3),"One of your credentials is invalid");if(o.aid&&n.sc){if(n.sc.length>10)throw new Error(m)}else if(n.name&&n.password){if(i=n.name.search(c.regex),a=n.password.search(l.regex),n.name.length<5||n.name.length>50)throw new Error("Userid must be 5 characters minimum and 50 characters maximum.");if(n.password.length<8||n.password.length>50)throw new Error("Password must be 8 characters minimum and 50 characters maximum.");if(0!==i&&0!==a)throw new Error(m)}n.fe=JSON.stringify({u:n.name,p:n.password,s:n.sc});try{let i=await async function(e,n,o){try{if(e.be)n.be=Buffer.from(e.be).toString("base64"),n.uid=t.rid(8);else if(e.he)n.he=Buffer.from(e.he).toString("hex"),n.uid=t.rid(8);else if(e.fe){const o=await R("dck");g=_(g,o),e.name&&e.password&&(g.uc={},g.at={},g.uc.userid=e.name,g.uc.userpw=e.password,g.at.aad=Buffer.from(t.rid(12),"hex"),g.cp=crypto.createCipheriv(g.algo,g.cipkey1,g.nk,{authTagLength:16}),g.cp.setAAD(g.at.aad,{plaintextLength:Buffer.byteLength(JSON.stringify(g.uc))}),g.ucs=g.cp.update(JSON.stringify(g.uc),"utf8"),g.cp.final(),g.at.tag=g.cp.getAuthTag(),n.euc=g.ucs.toString("hex"),n.att=g.at.aad.toString("hex")+g.at.tag.toString("hex")),e.sc&&(g.sc={},g.sccp=crypto.createCipheriv(g.algo,g.cipkey2,g.nk,{authTagLength:16}),g.sc.esc=g.sccp.update(e.sc,"utf8"),g.sccp.final(),g.sc.stag=g.sccp.getAuthTag(),n.esc=Buffer.from(JSON.stringify(g.sc),"utf8").toString("hex")),n.uid=g.slt1,n.idn=g.slt2}return n}catch(e){throw t.logEvent("encryptUser (system/process) error:",JSON.stringify(e)),e}finally{setTimeout((()=>{e=null,g=null,n=null}),2e3)}}(n,o);r.connect(e,i,s)}catch(e){throw t.logEvent("authenticate - encryptUser (system) error:",JSON.stringify(e)),"authenticate - encryptUser error"}}function U(e,n,o,r){let s=[];"v-ep"===n._pid&&(n._pid="r-ep"),s.push({type:"input",message:"Enter your userid (email):",name:"name",validate:e=>!(e.search(c.regex)<0)||c.msg}),s.push({type:"password",message:"Enter your password:",name:"password",mask:"*",validate:e=>!(e.search(l.regex)<0)||l.msg}),n.aid&&(n.at="sc")&&(s=[{type:"password",message:"*Enter your security code:",name:"sc",mask:"*",validate:e=>!(e.length>10)||"Invalid security code"}],n.vsc=!0),console.log("\nPlease provide your credentials ...\n"),inquirer.prompt(s).then((t=>{L(e,t,n,o,r)})).catch((e=>{e.isTtyError?t.logEvent("userPrompt - inquirer error.isTtyError:",JSON.stringify(e)):t.logEvent("userPrompt - inquirer error:",JSON.stringify(e))}))}function P(e,t,n,o){let r={_sid:"m2m"};return r.id=e,r.srcId=e,r[t]=!0,r[n]=r[t],r.src=t,r._pid=o,r.active=!0,r.enable=!0,r.at="up","server"===t&&(r.serverId=e),"server"===t?r.serverId=e:"client"===t?r.clientId=e:"user"===t?r.userId=e:"endpoint"===t&&(r.endpointId=e),r}function J(e,n){try{let o=t.rid(4),r=b();if(n&&(r=null),e&&!e.options&&(e.options={}),e.arg&&"object"==typeof e.arg&&e&&e.options&&(e.options.userSettings=e.arg),e.ep){if(r&&r.ep)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(o,"endpoint","e","r-e");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.server){if(r&&r.id!==e.id&&(r=null),r&&r.server)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(e.id,"server","d","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.client){if(r&&r.client)return r.options=e.options,e.edgeEp?r.edgeEp=e.edgeEp:e.edgeUser&&(r.edgeUser=e.edgeUser),r;{const t=P(o,"client","c","r-ep");return t.options=e.options,e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t}}if(e.user||e.edgeEp||e.edgeUser){if(r&&r.user)return r.options=e.options,r;{const t=P(o,"user","u","r-ep");return e.edgeEp?t.edgeEp=e.edgeEp:e.edgeUser&&(t.edgeUser=e.edgeUser),t.options=e.options,t}}}catch(e){console.log("getEndpoint error:",e.message)}}async function B(e,t,o,r){try{let s=n.getSystemConfig();if(s.monFileStatus="reset",n.setSystemConfig(s),"-r"===processArgs[0]&&(t=J(t,!0)),t._sid="m2m",t.tid=Date.now(),t.aid?t.at="sc":t.at="pu",e&&"object"==typeof e){if(e.userid&&e.pw&&e.sc){"-r"!==processArgs[0]&&console.log("current user:",e.userid,"\n"),e.trial&&(t.trial=e.trial,t.startDate=Date.now());let n={};return n.name=e.userid,n.password=e.pw,n.sc=e.sc,"-r"===processArgs[0]?U(e,t,o,r):L(e,n,t,o,r)}if(r)return r(new Error("invalid credentials"))}U(e,t,o,r)}catch(e){throw new Error("m2mStart error:",e.message)}}return setTimeout((()=>{!function(){let e=Math.floor(5e3*Math.random()+1e3),o="m2m-module-update";r.listenerCount(o)<1&&r.on(o,(o=>{try{fs.readFileSync("./node_modules/m2m/package.json")}catch(e){return o.active=!0,o.error="Update fail. Cannot find/resolve node_modules directory.",delete o.file,delete o.code,r.emit("ws-emit-send",o),void t.logEvent("m2m module update error:",e.message)}if(o.aid===spl.aid){try{JSON.parse(o.file.package)}catch(e){return void t.logEvent("setModuleUpdateListener JSON.parse(rxd.file.package) error:",e.message)}n&&(n.stopMonEpFS(),n.stopMonEpApp());try{if(!o.path&&!o.file)return;o.file.client&&o.path.client&&fs.writeFileSync(o.path.client,o.file.client),o.file.m2m&&o.path.m2m&&fs.writeFileSync(o.path.m2m,o.file.m2m),o.file.supportLib&&o.path.supportLib&&fs.writeFileSync(o.path.supportLib,o.file.supportLib),o.file.nodeEdge&&o.path.nodeEdge&&fs.writeFileSync(o.path.nodeEdge,o.file.nodeEdge),o.file.package&&o.path.package&&fs.writeFileSync(o.path.package,o.file.package),setImmediate((()=>{o.active=!0,o.update="success",t.getRestartStatus()&&(o.restartable=!0),delete o.file,delete o.code,r.emit("ws-emit-send",o),t.logEvent("m2m module updated","v"+o.ver),o.restartable&&setTimeout((()=>{E.monFileStatus="m2m-module-update",n.setSystemConfig(E),fs.writeFileSync("node_modules/m2m/mon","m2m-module-update")}),e)}))}catch(e){t.logEvent("setModuleUpdateListener fs.writeFileSync(path.client, client) error:",e)}}}))}()}),100),{setCtk:C,readCtk:b,decSC:function(e,n){if(p&&Object.keys(p).length>0)try{return p.dec=crypto.createCipheriv(p.algo,p.cipkey2,p.nk,{authTagLength:16}),p.decData=p.dec.update(e.edata,"hex","utf8"),p.decData+=p.dec.final("utf8"),n?n(null,p.decData):p.decData}catch(e){if(t.logEvent("decSC error:",JSON.stringify(e)),n)return n(e,null);throw e}finally{setTimeout((()=>{e=null,p=null}),2e3)}},m2mStart:B,m2mRestart:function(e,o,r,s){try{o=J(o);let i=n.getSystemConfig();if(i.zta&&(o.aid?o.at="sc":o.at="pu",!i||i&&"reset"===i.monFileStatus))return void B(e,o,r,s);if(o.aid&&o.did)return void process.nextTick(r.connect,e,o,s);let a=w(),c=fs.readFileSync(a,"utf8"),l=JSON.parse(Buffer.from(c,"base64").toString("utf8"));setImmediate((()=>{!function(e,n,o,r,s){try{if(console.log("\n"),n.client&&o.id&&"number"==typeof o.id)return console.log("Endpoint has changed from server to client, please register your new client."),B(e,n,r,s);if(n.client&&o.client&&o.clientId&&o.clientId!==n.clientId)return console.log("Client id has changed from",o.id,"to",n.id,"please register your new client."),B(e,n,r,s);if(n.client&&o.user)return console.log("Endpoint has changed from user to client, please register your new client."),B(e,n,r,s);if(n.server&&o.client&&o.id&&"string"==typeof o.id)return console.log("Endpoint has changed from client to server, please register your new server."),B(e,n,r,s);if(n.server&&o.user&&o.id&&"string"==typeof o.id)return console.log("Endpoint has changed from user to server, please register your new server."),B(e,n,r,s);if(n.server&&o.id&&o.id!==n.id)return console.log("Server id has changed from",o.id,"to",n.id,", please register your new server."),B(e,n,r,s);if(n.server&&!o.id)return console.log("Registering new server.\n"),B(e,n,r,s);if(n.user&&(o.server||o.client))return console.log("Endpoint has changed from client/server to user/edge, please register new user/edge."),B(e,n,r,s);if(!(n.server||n.client||n.user||n.endpoint)){if(o.user)return console.log("Register new endpoint.\n"),B(e,n,r,s);console.log("Verifying existing endpoint."),o._pid="r-e"}process.nextTick(r.connect,e,o,s)}catch(e){t.logEvent("validateCtkn error:",JSON.stringify(e))}}(e,o,l,r,s)}))}catch(n){try{let n=fs.readFileSync(t.secTkn.getRtk(),"utf8"),o=JSON.parse(Buffer.from(n,"base64").toString("utf8")),i=Object.assign({},o);B(e,i,r,s)}catch(t){B(e,o,r,s)}}},userPrompt:U,autoRestart:function(e){try{E.monFileStatus="auto-restart",n.setSystemConfig(E),e.server?fs.writeFileSync("node_modules/m2m/mon","auto-restart"):setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","auto-restart")),1e3)}catch(e){t.logEvent("autoRestart error:",e.message)}},rxCommonData:function(e,s,c,l){try{if(e.restart)l&&l.access(e),function(e){try{try{fs.readFileSync("./node_modules/m2m/package.json")}catch(n){return e.active=!0,e.error="Update fail. Cannot find/resolve node_modules directory.",r.emit("ws-emit-send",e),void t.logEvent("restart error:",n.message)}let s=Math.floor(5e3*Math.random()+1e3);e.active=!0,e.result="fail",e.restartable=!1,e.enable=o.getEnableStatus(),t.getRestartStatus()&&(n&&(n.stopMonEpFS(),n.stopMonEpApp()),e.data&&C(e.path,e.data),e.result="success",e.restartable=!0,t.logEvent("process restarted remotely"),E.monFileStatus="m2m-restart-process",n.setSystemConfig(E),setTimeout((()=>fs.writeFileSync("node_modules/m2m/mon","m2m-restart-process")),s)),r.emit("ws-emit-send",e)}catch(e){t.logEvent("restartProcess error:",e.message)}}(e);else if(e.status)!function(e,s,i){try{e.options=options,e.systemInfo=t.systemInfo,e.active=!0,e.enable=o.getEnableStatus(),e.containerized=t.systemInfo.container;let a=n.getSystemConfig(e);a&&(e.sc=a),t.getRestartStatus()&&(e.restartable=!0),"client-status"===e._pid?(dm||(dm=dmLib(t)),dm&&s&&(e.clientserverId=s.getValidServers(),e.clientAccessData=dm.resources.getClientAccessData(s))):"server-status"===e._pid&&i&&i.serverSetup&&(e.serverSetup=i.serverSetup);try{let t=fs.readFileSync("./node_modules/m2m/package.json","utf8");if(t){let n=JSON.parse(t);e.systemInfo.m2mv="v"+n.version}}catch(e){console.log("readFileSync pkgJson error:",e.message)}setImmediate((()=>{r.emit("ws-emit-send",e)}))}catch(e){t.logEvent("getEndpointStatus error:",e.message)}}(e,s,c);else if(e.secureSystem)!function(e){try{e.active=!0,e.on&&(h=!1),e.result="success",t.logEvent("process","secure system enabled"),r.emit("ws-emit-send",e)}catch(e){t.logEvent("secureSystem error:",e.message)}}(e);else if(e.updateCode)!function(e){e.active=!0;try{if(!e.appData)return e.appData="filename does not exist.",e.error={permission:!0,file:null},r.emit("ws-emit-send",e);if(e.updateCode&&Object.keys(options).length>0&&options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow){if(options.m2mConfig.code.filename){t.getRestartStatus()&&(e.restartable=!0),n&&n.stopMonEpApp();let o=Buffer.from(e.appData,"base64").toString("utf8");return!1===o.includes("require('m2m')",0)?void t.logEvent("updateCode error:remote browser app code is not in utf8 format"):fs.writeFile(options.m2mConfig.code.filename,o,(o=>{if(o)return"ENOENT"===o.code?e.appData="filename does not exist.":e.appData=o,t.logEvent("application code update error:",o.message),e.error={permission:!0,file:null},r.emit("ws-emit-send",e);delete e.appData,e.success=!0,r.emit("ws-emit-send",e),n&&n.startMonEpApp(options.m2mConfig.code.filename),t.logEvent("application code updated",options.m2mConfig.code.filename),setImmediate((()=>{E.monFileStatus="app-code-update",n.setSystemConfig(E),fs.writeFileSync("node_modules/m2m/mon","app-code-update")}))}))}return e.error={permission:!0,file:null},t.logEvent("updateCode missing filename error:",options.m2mConfig),r.emit("ws-emit-send",e)}return e.error={permission:!1},t.logEvent("updateCode missing options.m2mConfig.code error:",options),r.emit("ws-emit-send",e)}catch(e){t.logEvent("updateCode error:",e.message)}}(e);else if(e.uploadCode)!function(e){e.active=!0;try{if(e.uploadCode&&Object.keys(options).length>0)return options.m2mConfig&&options.m2mConfig.code&&options.m2mConfig.code.allow&&options.m2mConfig.code.filename?(e.processFilename=options.m2mConfig.code.filename,function(e,n){let s=o.getConnectionOptions();fs.readFile(e,"utf8",((e,o)=>{try{if(e)return"ENOENT"===e.code?n.appData="filename does not exist.":n.appData=e,n.error={permission:!1,file:null},r.emit("ws-emit-send",n);let t=Buffer.from(o);if(s&&s.pw)return n.error={pw:!0,permission:!1,file:null},r.emit("ws-emit-send",n);n.success=!0,n.enc?M(o,n,"priv"):(n.appData=t.toString("base64"),r.emit("ws-emit-send",n))}catch(e){t.logEvent("getCodeData error:",e.message)}}))}(options.m2mConfig.code.filename,e)):(e.error={permission:!0,file:null},r.emit("ws-emit-send",e));e.error={permission:!1},r.emit("ws-emit-send",e)}catch(e){t.logEvent("uploadCode error:",e.message)}}(e);else if(e.moduleUpdate)r.emit("m2m-module-update",e);else if(e.uploadCliLog)!function(e){e.active=!0,e.uploadCliLog&&function(e){try{let t=fs.readFileSync(e.filename,"utf8");if(t.length>a)return j(D(t,e),e);if(e.enc)return M(t,e,"priv");j(t,e)}catch(t){N(t,e)}}(e)}(e);else if(e.clearCliLog)!function(e){e.active=!0;try{t.rid(4),fs.readFileSync(e.filename,"utf8"),setTimeout((()=>{(e.clearCliLog||e.clearEventLog)&&function(e){let n="";e.clearEventLog&&(n=t.eventLogHeader);try{fs.writeFileSync(e.filename,n),e.success=!0,r.emit("ws-emit-send",e)}catch(t){return N(t,e)}}(e)}),300)}catch(n){t.logEvent("clearLogFile error:",n.message),e.error="Cannot clear log file",r.emit("ws-emit-send",e)}}(e);else if(e.acli)!function(e){e.success=!0,T(e,((n,o)=>{try{n?(i[o].cli.kill("SIGSTOP"),i[o].cli.killed?O(e,"Aborted\n\n",I):O(e,"Abort fail\n\n",I)):O(e,"Already executed, nothing to abort\n\n",I)}catch(e){t.logEvent("aCli error:",e.message)}}))}(e);else if(e.scli){if(e.ers)return l&&l.access(e),void k(e);!function(e){try{if(e.ers)return k(e);!function(e,n,o){let r=null,s="",a=null;try{e.opt&&(a=e.opt);let c=spawn(n,{stdio:a,shell:!0}),l={cli:c,cmd:e.cli,pid:c.pid,killed:c.killed,cliId:e.cliId};i.push(l),n=null,e.success=!0,"win32"!==process.platform&&(r=setTimeout((()=>{s+=e.crp,T(e),O(e,s+"\n",o)}),3e3),c.stdout.on("data",(e=>{s+=e.toString(),clearTimeout(r)})),c.stderr.on("data",(e=>{let t=e.toString().search("no password was provided"),n=e.toString().search("password for");-1===t&&-1===n&&(s+=e.toString())}))),c.on("close",((t,n)=>{clearTimeout(r),n&&(s+="Command aborted\n"),e.code=t,T(e),O(e,s+"\n",o)})),c.on("exit",((e,t)=>{})),c.on("node-m2m-error",(n=>{t.logEvent("cli execution error:",n.toString()),O(e,s+"error: "+n.toString()+"\n",o)})),c.stdin.end()}catch(n){t.logEvent("exeBrCli error:",n.message),O(e,"Execution error. Please try again later.\n\n",o)}}(e,Buffer.from(e.pl,"base64").toString("utf8"),(e=>{I(e)}))}catch(e){t.logEvent("eCli error:",e.message)}}(e)}else e.setEpSec?o.setEpSecPolicy(e):e.suspend?n.suspend(e,c):e.getUserResources||e.startAccessRateMonitor||e.stopAccessRateMonitor?o.getUserResources(e,s,c):e.edgeResources?l&&l.resources(e):e.accessEdge&&l&&l.access(e)}catch(e){t.logEvent("rxCommonData error:",e.message)}},getCurrentProcessName:function(){return v}}};